<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Cake - POS System Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo {
            font-size: 2em;
            font-weight: bold;
            color: #e91e63;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .nav-tab.active {
            background: #e91e63;
            color: white;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
        
        .pos-section, .cart-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .category-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .category-btn.active {
            background: #e91e63;
            color: white;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .product-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .product-card:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateY(-2px);
        }
        
        .product-card.family-cake {
            border-left: 4px solid #e91e63;
        }
        
        .product-card.others {
            border-left: 4px solid #4caf50;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 8px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .product-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
            line-height: 1.2;
        }
        
        .product-info {
            font-size: 10px;
            color: #666;
        }
        
        .cart-content {
            padding: 20px;
        }
        
        .customer-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .cart-total {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.2em;
            color: #e91e63;
        }
        
        .profit-row {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }
        
        .btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #e91e63;
            color: white;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .variant-selector {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .variant-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .variant-option:hover {
            background: #f8f9fa;
        }
        
        .variant-option.active {
            border-color: #e91e63;
            background: #fce4ec;
        }
        
        .variant-option.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .variant-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .variant-price {
            color: #e91e63;
            font-size: 14px;
        }
        
        .variant-stock {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .price-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .price-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .price-option.active {
            border-color: #e91e63;
            background: #fce4ec;
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .qty-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #e91e63;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
        }
        
        .qty-display {
            font-size: 24px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
        }
        
        .cart-item-name {
            color: #e91e63;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: all 0.3s ease;
        }
        
        .cart-item-name:hover {
            text-decoration-color: #e91e63;
            color: #c2185b;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .inventory-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .inventory-card.low-stock {
            border-color: #ffc107;
            background: #fffbf0;
        }
        
        .inventory-card.out-of-stock {
            border-color: #dc3545;
            background: #ffe6e6;
        }
        
        .product-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .product-thumb {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 15px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .variant-list {
            display: grid;
            gap: 10px;
        }
        
        .variant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .stock-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .stock-badge.normal {
            background: #d4edda;
            color: #155724;
        }
        
        .stock-badge.low {
            background: #fff3cd;
            color: #856404;
        }
        
        .stock-badge.out {
            background: #f8d7da;
            color: #721c24;
        }
        
        .image-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .upload-btn {
            padding: 8px 16px;
            background: #e91e63;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .variant-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .variant-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 10px;
        }
        
        .products-list {
            display: grid;
            gap: 15px;
        }
        
        .product-management-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }
        
        .variant-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .supplier-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 15px;
        }
        
        .po-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            margin-bottom: 15px;
        }
        
        .po-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .po-status.pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .po-status.received {
            background: #d4edda;
            color: #155724;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #e91e63;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>

        <!-- Login Screen -->
        <div id="loginScreen" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); width: 90%; max-width: 400px;">
                <h2 style="text-align: center; color: #e91e63; margin-bottom: 30px;">🎂 Family Cake POS</h2>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" placeholder="Enter username" />
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" placeholder="Enter password" />
                </div>
                <div id="loginError" style="color: #dc3545; margin-bottom: 15px; display: none;"></div>
                <button class="btn btn-primary" id="loginBtn" style="width: 100%;">Login</button>
            </div>
        </div>

    <div class="container" id="mainContainer" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="logo">🎂 Family Cake</div>
                <button id="logoutBtn" class="btn btn-danger btn-sm" onclick="logout()" style="display: none;">Logout</button>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('pos', event)">POS</button>
                <button class="nav-tab" onclick="showTab('products', event)">Products</button>
                <button class="nav-tab" onclick="showTab('inventory', event)">Inventory</button>
                <button class="nav-tab" onclick="showTab('customers', event)">Customers</button>
                <button class="nav-tab" onclick="showTab('finance', event)">Finance</button>
                <button class="nav-tab" onclick="showTab('suppliers', event)">Suppliers</button>
                <button class="nav-tab" onclick="showTab('purchase-orders', event)">Purchase Orders</button>
                <button class="nav-tab" onclick="showTab('reports', event)">Reports</button>
                <button class="nav-tab" onclick="showTab('staff', event)" style="display: none;">Staff</button>
            </div>
        </div>

        <!-- POS Tab -->
        <div id="pos" class="tab-content active">
            <div class="main-content">
                <!-- Products Section -->
                <div class="pos-section">
                    <div class="section-header">
                        <div class="section-title">Products</div>
                        <div class="category-filter">
                            <button class="category-btn active" onclick="filterProducts('all', event)">All</button>
                            <button class="category-btn" onclick="filterProducts('family-cake', event)">Family Cake</button>
                            <button class="category-btn" onclick="filterProducts('others', event)">Others</button>
                        </div>
                    </div>
                    <div class="product-grid" id="productGrid">
                        <!-- Products will be loaded here dynamically -->
                    </div>
                </div>

                <!-- Cart Section -->
                <div class="cart-section">
                    <div class="section-header">
                        <div class="section-title">Current Sale</div>
                    </div>
                    <div class="cart-content">
                        <div style="position: relative;">
                            <input  type="text" 
                                    class="form-input" 
                                    id="customerInput" 
                                    placeholder="Type customer name or 'Walk-in'" 
                                    autocomplete="off"
                                    onkeyup="handleCustomerSearch(event)"
                                    onfocus="showCustomerSuggestions()"
                                    style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                            <div id="customerSuggestions" 
                                    style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e9ecef; border-radius: 8px; margin-top: 2px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            </div>
                        </div>
                        <div id="selectedCustomerInfo" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 14px; display: none;">
                        </div>

                        <div class="cart-items" id="cartItems">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                Cart is empty
                            </div>
                        </div>

                        <div class="cart-total" id="cartTotal" style="display: none;">
                            <div class="total-row">
                                <span>Total:</span>
                                <span id="total">0 MMK</span>
                            </div>
                            <div class="profit-row">
                                <span>Profit:</span>
                                <span id="totalProfit" style="color: #28a745; font-weight: bold;">0 MMK</span>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="clearCart()">Clear</button>
                            <button class="btn btn-primary" onclick="showCheckout()" id="checkoutBtn" disabled>Checkout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Management Tab -->
        <div id="products" class="tab-content">
            <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
                <div class="section-header">
                    <div class="section-title">Product Management</div>
                    <button class="btn btn-primary" onclick="showAddProductModal()" style="padding: 8px 16px; font-size: 14px;">
                        + Add New Product
                    </button>
                </div>
                <div style="padding: 20px;">
                    <div id="productsList" class="products-list">
                        <!-- Products will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
                <div class="section-header">
                    <div class="section-title">Inventory Management</div>
                </div>
                <div style="padding: 20px;">
                    <div id="inventoryGrid" class="inventory-grid">
                        <!-- Inventory items will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Suppliers Tab -->
        <div id="suppliers" class="tab-content">
            <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
                <div class="section-header">
                    <div class="section-title">Supplier Management</div>
                    <button class="btn btn-primary" onclick="showAddSupplierModal()" style="padding: 8px 16px; font-size: 14px;">
                        + Add New Supplier
                    </button>
                </div>
                <div style="padding: 20px;">
                    <div id="suppliersList">
                        <!-- Suppliers will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Orders Tab -->
        <div id="purchase-orders" class="tab-content">
            <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
                <div class="section-header">
                    <div class="section-title">Purchase Orders</div>
                    <button class="btn btn-primary" onclick="showCreatePOModal()" style="padding: 8px 16px; font-size: 14px;">
                        + Create Purchase Order
                    </button>
                </div>
                <div style="padding: 20px;">
                    <div id="purchaseOrdersList">
                        <!-- Purchase orders will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

       <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
                <div class="section-header">
                    <div class="section-title">Reports & Analytics</div>
                    <div style="padding: 20px;">
                        <div id="statsGrid" class="stats-grid">
                            </div>

                        <div id="profitReport" style="margin-top: 30px;">
                            </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="dateRangeDisplay" style="font-size: 14px; color: #666;">Showing data for: Today</span>
                        <button class="btn btn-primary btn-sm" onclick="showDatePickerModal()">Change Date</button>
                        <button class="btn btn-info" id="exportBtn" onclick="showExportOptionsModal()" style="padding: 8px 16px; font-size: 14px;">
                            📊 Export to Excel
                        </button>
                    </div>
                </div>
                    
                    <!-- Stock Movement Log -->
                    <h3 style="margin-bottom: 15px; margin-top: 30px;">Stock Movement Log</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; text-align: left;">Date & Time</th>
                                    <th style="padding: 10px; text-align: left;">Product</th>
                                    <th style="padding: 10px; text-align: left;">Variant</th>
                                    <th style="padding: 10px; text-align: left;">Type</th>
                                    <th style="padding: 10px; text-align: left;">Qty</th>
                                    <th style="padding: 10px; text-align: left;">Cost</th>
                                    <th style="padding: 10px; text-align: left;">Profit</th>
                                    <th style="padding: 10px; text-align: left;">Stock After</th>
                                </tr>
                            </thead>
                            <tbody id="stockLogBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                        No stock movements recorded yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Customers Tab -->
    <div id="customers" class="tab-content">
        <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
            <div class="section-header">
                <div class="section-title">Customer Management</div>
                <button class="btn btn-primary" onclick="showAddCustomerModal()" style="padding: 8px 16px; font-size: 14px;">
                    + Add New Customer
                </button>
            </div>
            <div style="padding: 20px;">
                <div id="customersList">
                    <!-- Customers will be loaded here -->
            </div>
        </div>
    </div>
</div>
    <!-- Finance Tab -->
    <div id="finance" class="tab-content">
        <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
            <div class="section-header">
                <div class="section-title">Finance & Bookkeeping</div>
            </div>
            <div style="padding: 20px;">
                <!-- Finance Sub-tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-sm" onclick="showFinanceSection('cash-register')" id="cashRegisterBtn">Cash Register</button>
                    <button class="btn btn-secondary btn-sm" onclick="showFinanceSection('expenses')" id="expensesBtn">Expenses</button>
                    <button class="btn btn-secondary btn-sm" onclick="showFinanceSection('income')" id="incomeBtn">Other Income</button>
                    <button class="btn btn-secondary btn-sm" onclick="showFinanceSection('credit')" id="creditBtn">Customer Credit</button>
                    <button class="btn btn-secondary btn-sm" onclick="showFinanceSection('waste')" id="wasteBtn">Spoilage/Waste</button>
                </div>
            
                <!-- Cash Register Section -->
                <div id="cashRegisterSection" class="finance-section">
                    <h3>Daily Cash Register</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4>Opening Balance</h4>
                            <input type="number" class="form-input" id="openingBalance" placeholder="Enter opening balance" />
                            <button class="btn btn-primary btn-sm" style="margin-top: 10px;" onclick="setOpeningBalance()">Set Opening</button>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4>Current Status</h4>
                            <div style="font-size: 1.2em; margin-top: 10px;">
                                <div>Opening: <span id="displayOpening" style="color: #17a2b8;">0 MMK</span></div>
                                <div>Sales: <span id="displaySales" style="color: #28a745;">0 MMK</span></div>
                                <div>Expenses: <span id="displayExpenses" style="color: #dc3545;">0 MMK</span></div>
                                <div style="font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 2px solid #dee2e6;">
                                    Expected: <span id="expectedCash" style="color: #e91e63;">0 MMK</span>
                                </div>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4>Closing Balance</h4>
                            <input type="number" class="form-input" id="closingBalance" placeholder="Enter actual closing balance" />
                            <button class="btn btn-success btn-sm" style="margin-top: 10px;" onclick="closeRegister()">Close Register</button>
                            <div style="margin-top: 10px;">
                                Difference: <span id="cashDifference" style="font-weight: bold;">0 MMK</span>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Expenses Section -->
                <div id="expensesSection" class="finance-section" style="display: none;">
                    <h3>Record Expense</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label class="form-label">Expense Category</label>
                                <select class="form-select" id="expenseCategory">
                                    <option value="utilities">Utilities</option>
                                    <option value="salary">Staff Salary</option>
                                    <option value="transport">Delivery/Transport</option>
                                    <option value="packaging">Packaging Materials</option>
                                    <option value="maintenance">Equipment Maintenance</option>
                                    <option value="miscellaneous">အထွေထွေစရိတ်</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-input" id="expenseAmount" placeholder="Enter amount" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="expensePayment">
                                    <option value="cash">Cash</option>
                                    <option value="mobile">Mobile Banking</option>
                                    <option value="card">Card</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Remarks/Notes</label>
                            <textarea class="form-input" id="expenseRemarks" rows="3" placeholder="Enter any notes about this expense..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="recordExpense()">Record Expense</button>
                    </div>
                
                    <h4>Recent Expenses</h4>
                    <div id="recentExpenses" style="max-height: 400px; overflow-y: auto;">
                        <!-- Recent expenses will be displayed here -->
                    </div>
                </div>
            
                <!-- Other Income Section -->
                <div id="incomeSection" class="finance-section" style="display: none;">
                    <h3>Record Other Income</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label class="form-label">Income Type</label>
                                <input type="text" class="form-input" id="incomeType" placeholder="e.g., Catering Service" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-input" id="incomeAmount" placeholder="Enter amount" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="incomePayment">
                                    <option value="cash">Cash</option>
                                    <option value="mobile">Mobile Banking</option>
                                    <option value="card">Card</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input" id="incomeNotes" rows="3"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="recordIncome()">Record Income</button>
                    </div>
                </div>
            
                <!-- Customer Credit Section -->
                <div id="creditSection" class="finance-section" style="display: none;">
                    <h3>Customer Credit Management</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4>Add Credit Sale</h4>
                            <div class="form-group">
                                <label class="form-label">Customer</label>
                                <select class="form-select" id="creditCustomer">
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-input" id="creditAmount" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-input" id="creditNotes" rows="2"></textarea>
                            </div>
                            <button class="btn btn-warning" onclick="addCredit()">Add Credit</button>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <h4>Record Payment</h4>
                            <div class="form-group">
                                <label class="form-label">Customer</label>
                                <select class="form-select" id="paymentCustomer" onchange="updateCreditBalance()">
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                            <div style="margin: 10px 0; font-weight: bold;">
                                Outstanding: <span id="outstandingAmount">0 MMK</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Amount</label>
                                <input type="number" class="form-input" id="paymentAmount" />
                            </div>
                            <button class="btn btn-success" onclick="recordCreditPayment()">Record Payment</button>
                        </div>
                    </div>
                    <h4 style="margin-top: 20px;">Credit Summary</h4>
                    <div id="creditSummary"></div>
                </div>
            
                <!-- Spoilage/Waste Section -->
                <div id="wasteSection" class="finance-section" style="display: none;">
                    <h3>Record Spoilage/Waste</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <div class="form-group">
                            <label class="form-label">Select Product</label>
                            <select class="form-select" id="wasteProduct" onchange="updateWasteVariants()">
                                <option value="">Select Product</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Select Variant</label>
                            <select class="form-select" id="wasteVariant">
                                <option value="">Select Variant</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input" id="wasteQuantity" min="1" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason/Remarks</label>
                            <textarea class="form-input" id="wasteRemarks" rows="3" placeholder="Explain reason for disposal..."></textarea>
                        </div>
                        <button class="btn btn-danger" onclick="recordWaste()">Record Waste</button>
                    </div>
                    <h4 style="margin-top: 20px;">Recent Waste Records</h4>
                    <div id="wasteRecords"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Tab (Owner Only) -->
    <div id="staff" class="tab-content">
        <div style="background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden;">
            <div class="section-header">
                <div class="section-title">Staff Management</div>
                <button class="btn btn-primary" onclick="showAddUserModal()" style="padding: 8px 16px; font-size: 14px;">
                    + Add New User
                </button>
            </div>
            <div style="padding: 20px;">
                <div id="usersList">
                    <!-- Users list will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Product Selection Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <div id="productModalContent">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productEditModal')">&times;</span>
            <h3 id="productEditTitle">Add New Product</h3>
            
            <div class="form-group">
                <label class="form-label">Product Name</label>
                <input type="text" class="form-input" id="productName" placeholder="e.g., Cream Roll Bread" />
            </div>
            
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="productCategory">
                    <option value="family-cake">Family Cake</option>
                    <option value="others">Others</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Supplier (Hold Ctrl/Cmd to select multiple)</label>
                <select class="form-select" id="productSupplier" multiple style="min-height: 100px;"></select>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Product Image</label>
                <div class="image-upload">
                    <div class="image-preview" id="imagePreview">
                        <span style="color: #999;">No image</span>
                    </div>
                    <div>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)" />
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">Choose Image</button>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Low Stock Threshold</label>
                <input type="number" class="form-input" id="lowStockThreshold" value="5" min="1" />
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Variants</span>
                    <button class="btn btn-success btn-sm" onclick="addVariantForm()">+ Add Variant</button>
                </label>
                <div id="variantsList">
                    <!-- Variant forms will be added here -->
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-secondary" onclick="closeModal('productEditModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('checkoutModal')">&times;</span>
            <h2>Checkout</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3>Receipt Preview</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; font-family: monospace;" id="receiptPreview">
                        Receipt will be shown here
                    </div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 3em; font-weight: bold; color: #e91e63; margin-bottom: 30px;" id="checkoutTotal">0 MMK</div>
                    <input type="number" style="font-size: 2em; text-align: center; padding: 20px; border: 3px solid #e91e63; border-radius: 10px; margin-bottom: 20px; width: 100%;" id="amountReceived" placeholder="Amount Received" />
                    <button style="font-size: 1.5em; padding: 20px 40px; background: #28a745; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;" onclick="processPayment()">Charge</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('stockModal')">&times;</span>
            <h3>Adjust Stock</h3>
            <div id="stockModalContent">
                <!-- Stock adjustment content will be loaded here -->
            </div>
        </div>
    </div>

    <script>

        // User management variables
        let users = [];
        let loggedInUser = null;

        // Default users
        const defaultUsers = [
            { id: 1, name: 'Owner', username: 'owner', password: 'admin123', role: 'owner' },
            { id: 2, name: 'Finance Manager', username: 'finance', password: 'finance123', role: 'finance' },
            { id: 3, name: 'Cashier', username: 'cashier', password: 'cash123', role: 'cashier' }
        ];

        // Load users from localStorage or use defaults
        function loadUsers() {
            const savedUsers = localStorage.getItem('familyCakeUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                users = [...defaultUsers];
                localStorage.setItem('familyCakeUsers', JSON.stringify(users));
            }
        }                 
               // Global variables
        let cart = [];
        let currentProduct = null;
        let currentVariant = null;
        let editingProductId = null;
        let editingCartIndex = null;
        let editingSupplierId = null;
        let stockMovements = [];
        let variantCounter = 0;
        
        // Enhanced data structures
        let products = [];
        let suppliers = [];
        let purchaseOrders = [];
        let customers = [];
        let selectedCustomer = null;
        let currentSuggestionIndex = -1;

        // Finance variables
        let expenses = [];
        let otherIncome = [];
        let cashRegister = {
            date: new Date().toDateString(),
            opening: 0,
            sales: 0,
            expenses: 0,
            closing: 0,
            difference: 0
        };
        let customerCredits = [];
        let wasteRecords = [];
        let ownerDrawings = [];

        // Report date range variables
        let reportStartDate = new Date();
        let reportEndDate = new Date();
        let currentCalendarMonth = new Date();

        // User authentication functions
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
    
            // Find matching user
            const user = users.find(u => u.username === username && u.password === password);
    
            if (user) {
                // Successful login
                loggedInUser = user;
                errorDiv.style.display = 'none';
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
        
                // Update UI based on role
                updateUIForRole();
        
                // Clear login form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
        
                // Show POS tab by default
                showTab('pos', { target: document.querySelector('.nav-tab') });
            } else {
                // Failed login
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Invalid username or password';
            }
        }

        function logout() {
            loggedInUser = null;
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }
        function updateUIForRole() {
        if (!loggedInUser) return;
    
        const role = loggedInUser.role;
        const logoutBtn = document.getElementById('logoutBtn');
    
        // Show logout button for all logged-in users
        logoutBtn.style.display = 'block';
    
        // Get all nav tabs
        const tabs = {
            pos: document.querySelector('.nav-tab[onclick*="pos"]'),
            products: document.querySelector('.nav-tab[onclick*="products"]'),
            inventory: document.querySelector('.nav-tab[onclick*="inventory"]'),
            customers: document.querySelector('.nav-tab[onclick*="customers"]'),
            finance: document.querySelector('.nav-tab[onclick*="finance"]'),
            suppliers: document.querySelector('.nav-tab[onclick*="suppliers"]'),
            purchaseOrders: document.querySelector('.nav-tab[onclick*="purchase-orders"]'),
            reports: document.querySelector('.nav-tab[onclick*="reports"]'),
            staff: document.querySelector('.nav-tab[onclick*="staff"]')
        };
    
        // Hide all tabs first
        Object.values(tabs).forEach(tab => {
            if (tab) tab.style.display = 'none';
        });
    
        // Show tabs based on role
        switch(role) {
            case 'owner':
                // Owner sees all tabs
                Object.values(tabs).forEach(tab => {
                    if (tab) tab.style.display = 'block';
                });
                break;
            
            case 'finance':
                // Finance sees: Finance, Reports, Products, Suppliers, Customers, Inventory
                if (tabs.finance) tabs.finance.style.display = 'block';
                if (tabs.reports) tabs.reports.style.display = 'block';
                if (tabs.products) tabs.products.style.display = 'block';
                if (tabs.suppliers) tabs.suppliers.style.display = 'block';
                if (tabs.customers) tabs.customers.style.display = 'block';
                if (tabs.inventory) tabs.inventory.style.display = 'block';
                break;
            
            case 'cashier':
                // Cashier sees: POS, Purchase Orders, Products, Reports, Customers
                if (tabs.pos) tabs.pos.style.display = 'block';
                if (tabs.purchaseOrders) tabs.purchaseOrders.style.display = 'block';
                if (tabs.products) tabs.products.style.display = 'block';
                if (tabs.reports) tabs.reports.style.display = 'block';
                if (tabs.customers) tabs.customers.style.display = 'block';
                break;
        }
    
        // Display welcome message
        const userInfo = document.createElement('div');
        userInfo.id = 'userInfo';
        userInfo.style.cssText = 'position: absolute; top: 10px; right: 10px; color: white; font-size: 14px;';
        userInfo.innerHTML = `Welcome, ${loggedInUser.name} (${loggedInUser.role})`;
    
        // Remove old userInfo if exists
        const oldUserInfo = document.getElementById('userInfo');
        if (oldUserInfo) oldUserInfo.remove();
    
        document.querySelector('.header').appendChild(userInfo);
    
        // Restrict export functionality for cashiers
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            if (loggedInUser.role === 'cashier') {
                exportBtn.style.display = 'none';
            } else {
                exportBtn.style.display = 'inline-block';
            }
        }
    }

        // Staff Management Functions
        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;
    
            usersList.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    ${users.map(user => `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h4>${user.name}</h4>
                                    <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                        <strong>Username:</strong> ${user.username}<br>
                                        <strong>Role:</strong> ${user.role}<br>
                                        <strong>Status:</strong> <span style="color: ${user.id === loggedInUser?.id ? '#28a745' : '#6c757d'};">
                                            ${user.id === loggedInUser?.id ? 'Currently Logged In' : 'Inactive'}
                                        </span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-warning btn-sm" onclick="showResetPasswordModal(${user.id})">Reset Password</button>
                                    ${user.id !== loggedInUser?.id ? 
                                        `<button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>` 
                                        : ''
                                    }
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showAddUserModal() {
            const modalHtml = `
                <div id="userModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('userModal')">&times;</span>
                        <h3>Add New User</h3>
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="newUserName" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-input" id="newUsername" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-input" id="newUserPassword" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="newUserRole">
                                <option value="cashier">Cashier</option>
                                <option value="finance">Finance Manager</option>
                                <option value="owner">Owner</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="addNewUser()">Add User</button>
                        </div>
                    </div>
                </div>
            `;
    
            const existingModal = document.getElementById('userModal');
            if (existingModal) existingModal.remove();
    
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function showResetPasswordModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('User not found');
                return;
            }
    
            const modalHtml = `
                <div id="resetPasswordModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('resetPasswordModal')">&times;</span>
                        <h3>Reset Password for ${user.name}</h3>
                        <div class="form-group">
                            <label class="form-label">Owner's Current Password (for verification)</label>
                            <input type="password" class="form-input" id="ownerPassword" placeholder="Enter your password to verify" />
                        </div>
                        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e9ecef;">
                        <div class="form-group">
                            <label class="form-label">New Password for ${user.name}</label>
                            <input type="password" class="form-input" id="newPassword" placeholder="Enter new password" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm new password" />
                        </div>
                        <div id="passwordError" style="color: #dc3545; margin-bottom: 15px; display: none;"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="processPasswordReset(${userId})">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
    
            const existingModal = document.getElementById('resetPasswordModal');
            if (existingModal) existingModal.remove();
    
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function processPasswordReset(userId) {
            const ownerPassword = document.getElementById('ownerPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
    
            // Clear previous errors
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
    
            // Validation checks
            if (!ownerPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                errorDiv.style.display = 'block';
                return;
            }
    
            // Check if new passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }
    
            // Check if new password meets minimum requirements
            if (newPassword.length < 3) {
                errorDiv.textContent = 'New password must be at least 3 characters long';
                errorDiv.style.display = 'block';
                return;
            }
    
            // Verify owner's password
            if (ownerPassword !== loggedInUser.password) {
                errorDiv.textContent = 'Incorrect owner password. Access denied.';
                errorDiv.style.display = 'block';
                return;
            }
    
            // Find and update user
            const user = users.find(u => u.id === userId);
            if (!user) {
                errorDiv.textContent = 'User not found';
                errorDiv.style.display = 'block';
                return;
            }
    
            // Update password
            user.password = newPassword;
    
            // If changing own password, update loggedInUser too
            if (userId === loggedInUser.id) {
                loggedInUser.password = newPassword;
            }
    
            // Save changes
            saveUsers();
    
            // Close modal and show success
            closeModal('resetPasswordModal');
            alert(`Password successfully updated for ${user.name}`);
        }

        function addNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
    
            if (!name || !username || !password) {
                alert('Please fill all fields');
                return;
            }
    
            // Check if username already exists
            if (users.some(u => u.username === username)) {
                alert('Username already exists');
                return;
            }
    
            const newUser = {
                id: Date.now(),
                name: name,
                username: username,
                password: password,
                role: role
            };
    
            users.push(newUser);
            localStorage.setItem('familyCakeUsers', JSON.stringify(users));
    
            updateUsersList();
            closeModal('userModal');
            alert('User added successfully!');
        }

        function saveUsers() {
            localStorage.setItem('familyCakeUsers', JSON.stringify(users));
        }

        function deleteUser(userId) {
            // Prevent deleting yourself
            if (userId === loggedInUser.id) {
                alert('You cannot delete your own account while logged in');
                return;
            }
    
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
    
            // Remove user from array
            users = users.filter(u => u.id !== userId);
    
            // Save and refresh
            saveUsers();
            updateUsersList();
            alert('User deleted successfully');
        }
        
        // Sample data initialization
        function initializeSampleData() {
            const sampleProducts = [
                {
                    id: 1,
                    name: 'Cream Roll Bread',
                    category: 'family-cake',
                    lowStockThreshold: 5,
                    supplierIds: [1],
                    image: null,
                    variants: [
                        {
                            id: 'v1',
                            name: 'Strawberry',
                            regularPrice: 15000,
                            wholesalePrice: 12000,
                            costPrice: 8000,
                            stock: 10
                        },
                        {
                            id: 'v2',
                            name: 'Blueberry',
                            regularPrice: 15000,
                            wholesalePrice: 12000,
                            costPrice: 8000,
                            stock: 8
                        },
                        {
                            id: 'v3',
                            name: 'Chocolate',
                            regularPrice: 16000,
                            wholesalePrice: 13000,
                            costPrice: 9000,
                            stock: 15
                        }
                    ]
                },
                {
                    id: 2,
                    name: 'Birthday Cake',
                    category: 'family-cake',
                    lowStockThreshold: 3,
                    supplierIds: [2],
                    image: null,
                    variants: [
                        {
                            id: 'v4',
                            name: '6 inch',
                            regularPrice: 35000,
                            wholesalePrice: 30000,
                            costPrice: 20000,
                            stock: 5
                        },
                        {
                            id: 'v5',
                            name: '8 inch',
                            regularPrice: 45000,
                            wholesalePrice: 40000,
                            costPrice: 28000,
                            stock: 3
                        }
                    ]
                }
            ];
            
            const sampleSuppliers = [
                {
                    id: 1,
                    name: 'ABC Bakery Supplies',
                    contact: '09-123456789',
                    email: 'abc@supplies.com',
                    address: 'Yangon',
                    paymentTerms: 'Net 30',
                    outstandingBalance: 0
                },
                {
                    id: 2,
                    name: 'Fresh Ingredients Co.',
                    contact: '09-987654321',
                    email: 'fresh@ingredients.com',
                    address: 'Mandalay',
                    paymentTerms: 'COD',
                    outstandingBalance: 0
                }
            ];
            
            return { products: sampleProducts, suppliers: sampleSuppliers };
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US').format(Math.round(amount)) + ' MMK';
        }

        // Validate product structure with COGS
        function validateProductStructure(product) {
            if (!product || typeof product !== 'object') return null;
            
            return {
                id: product.id || Date.now(),
                name: product.name || 'Unnamed Product',
                category: product.category || 'others',
                lowStockThreshold: product.lowStockThreshold || 5,
                supplierIds: Array.isArray(product.supplierIds) ? product.supplierIds :(product.supplierId ? [product.supplierId] : []),
                image: product.image || null,
                variants: Array.isArray(product.variants) ? product.variants.map(validateVariantStructure).filter(v => v !== null) : []
            };
        }

        // Validate variant structure with COGS
        function validateVariantStructure(variant) {
            if (!variant || typeof variant !== 'object') return null;
            
            return {
                id: variant.id || `v${Date.now()}-${Math.random()}`,
                name: variant.name || 'Default',
                regularPrice: parseInt(variant.regularPrice) || 0,
                wholesalePrice: parseInt(variant.wholesalePrice) || 0,
                costPrice: parseInt(variant.costPrice) || 0,
                stock: parseInt(variant.stock) || 0
            };
        }

        // Load all data from localStorage
        function loadProducts() {
            try {
                const savedProducts = localStorage.getItem('familyCakeProducts');
                const savedSuppliers = localStorage.getItem('familyCakeSuppliers');
                const savedPOs = localStorage.getItem('familyCakePurchaseOrders');
                
                if (savedProducts) {
                    const parsedProducts = JSON.parse(savedProducts);
                    // Add costPrice to existing variants if missing
                    products = parsedProducts.map(p => ({
                        ...p,
                        supplierIds: p.supplierIds || (p.supplierId ? [p.supplierId] : []),
                        variants: p.variants.map(v => ({
                            ...v,
                            costPrice: v.costPrice || Math.floor(v.wholesalePrice * 0.6)
                        }))
                    }));
                } else {
                    const sampleData = initializeSampleData();
                    products = sampleData.products;
                    suppliers = sampleData.suppliers;
                }
                
                if (savedSuppliers) {
                    suppliers = JSON.parse(savedSuppliers);
                } else if (!suppliers.length) {
                    const sampleData = initializeSampleData();
                    suppliers = sampleData.suppliers;
                }
                
                if (savedPOs) {
                    purchaseOrders = JSON.parse(savedPOs);
                }
                
                saveProducts();
            } catch (error) {
                console.error('Error loading data:', error);
                const sampleData = initializeSampleData();
                products = sampleData.products;
                suppliers = sampleData.suppliers;
                saveProducts();
            }
        }

        // Save all data to localStorage
        function saveProducts() {
            try {
                localStorage.setItem('familyCakeProducts', JSON.stringify(products));
                localStorage.setItem('familyCakeSuppliers', JSON.stringify(suppliers));
                localStorage.setItem('familyCakePurchaseOrders', JSON.stringify(purchaseOrders));
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }

        // Load stock movements
        function loadStockMovements() {
            try {
                const savedMovements = localStorage.getItem('familyCakeStockMovements');
                if (savedMovements) {
                    stockMovements = JSON.parse(savedMovements);
                }
            } catch (error) {
                console.error('Error loading stock movements:', error);
                stockMovements = [];
            }
        }

        // Save stock movements
        function saveStockMovements() {
            try {
                localStorage.setItem('familyCakeStockMovements', JSON.stringify(stockMovements));
            } catch (error) {
                console.error('Error saving stock movements:', error);
            }
        }

        // Enhanced log stock movement with profit tracking
        function logStockMovement(productId, variantId, type, quantity, newStock, reason = '', unitCost = 0, totalRevenue = 0) {
            const product = products.find(p => p.id === productId);
            const variant = product?.variants?.find(v => v.id === variantId);
            
            if (!product || !variant) return;
            
            let profit = 0;
            if (type === 'sale' && variant.costPrice) {
                profit = totalRevenue - (variant.costPrice * quantity);
            }
            
            const movement = {
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                productId: productId,
                productName: product.name,
                variantId: variantId,
                variantName: variant.name,
                type: type,
                quantity: quantity,
                newStock: newStock,
                cost: unitCost || variant.costPrice || 0,
                revenue: totalRevenue,
                profit: profit,
                reason: reason
            };
            
            stockMovements.unshift(movement);
            saveStockMovements();
            updateStockLogDisplay(startDate, endDate);
        }

        // Update POS product grid
        function updateProductGrid() {
            const productGrid = document.getElementById('productGrid');
            
            productGrid.innerHTML = products.map(product => {
                const variants = Array.isArray(product.variants) ? product.variants : [];
                const totalStock = variants.reduce((sum, v) => sum + (parseInt(v.stock) || 0), 0);
                const hasOutOfStock = variants.some(v => (parseInt(v.stock) || 0) === 0);
                const allOutOfStock = variants.length === 0 || variants.every(v => (parseInt(v.stock) || 0) === 0);
                
                const prices = variants.map(v => parseInt(v.wholesalePrice) || 0).filter(p => p > 0);
                const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
                const maxPrice = prices.length > 0 ? Math.max(...prices) : 0;
                const priceDisplay = minPrice === maxPrice 
                    ? formatCurrency(minPrice)
                    : `${formatCurrency(minPrice)} - ${formatCurrency(maxPrice)}`;
                
                return `
                    <div class="product-card ${product.category}" 
                         onclick="${allOutOfStock ? '' : `showProductModal(${product.id})`}"
                         style="${allOutOfStock ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                        <div class="product-image">
                            ${product.image 
                                ? `<img src="${product.image}" alt="${product.name}" />`
                                : `<span style="font-size: 30px;">📦</span>`
                            }
                        </div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-info">
                            ${variants.length} variants
                        </div>
                        <div style="font-size: 11px; color: #e91e63; font-weight: 600; margin-top: 4px;">
                            ${variants.length > 0 ? priceDisplay : 'No price set'}
                        </div>
                        <div style="font-size: 10px; margin-top: 4px; 
                            ${allOutOfStock ? 'color: #dc3545;' : hasOutOfStock ? 'color: #ffc107;' : 'color: #28a745;'} 
                            font-weight: 600;">
                            ${variants.length === 0 ? 'NO VARIANTS' : allOutOfStock ? 'OUT OF STOCK' : hasOutOfStock ? 'LIMITED STOCK' : `${totalStock} in stock`}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show product modal with variants
        function showProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || !product.variants || product.variants.length === 0) {
                alert('This product has no variants configured.');
                return;
            }
            
            currentProduct = product;
            currentVariant = null;
            editingCartIndex = null;
            
            const modal = document.getElementById('productModal');
            const content = document.getElementById('productModalContent');
            
            content.innerHTML = `
                <div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        ${product.image 
                            ? `<img src="${product.image}" style="max-width: 150px; max-height: 150px; border-radius: 10px;" />`
                            : `<div style="font-size: 60px;">📦</div>`
                        }
                        <h3 style="margin-top: 10px;">${product.name}</h3>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Select Variant</label>
                        <div class="variant-selector">
                            ${product.variants.map(variant => `
                                <div class="variant-option ${variant.stock === 0 ? 'out-of-stock' : ''}" 
                                     onclick="${variant.stock > 0 ? `selectVariant('${variant.id}')` : ''}"
                                     id="variant-${variant.id}">
                                    <div class="variant-name">${variant.name}</div>
                                    <div class="variant-price">
                                        Regular: ${formatCurrency(variant.regularPrice)} | 
                                        Wholesale: ${formatCurrency(variant.wholesalePrice)}
                                    </div>
                                    <div class="variant-stock ${variant.stock === 0 ? 'stock-badge out' : variant.stock <= product.lowStockThreshold ? 'stock-badge low' : 'stock-badge normal'}">
                                        ${variant.stock === 0 ? 'OUT OF STOCK' : `${variant.stock} available`}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="variantDetails" style="display: none;">
                        <div class="price-toggle">
                            <div class="price-option active" onclick="selectPriceType('regular')" id="regularOption">
                                <div style="font-weight: 600; margin-bottom: 5px;">Regular</div>
                                <div style="font-size: 1.2em; color: #e91e63; font-weight: bold;" id="regularPriceDisplay">-</div>
                            </div>
                            <div class="price-option" onclick="selectPriceType('wholesale')" id="wholesaleOption">
                                <div style="font-weight: 600; margin-bottom: 5px;">Wholesale</div>
                                <div style="font-size: 1.2em; color: #e91e63; font-weight: bold;" id="wholesalePriceDisplay">-</div>
                            </div>
                        </div>
                        
                        <div class="quantity-selector">
                            <button class="qty-btn" onclick="changeQuantity(-1)">-</button>
                            <input type="number" class="qty-display" id="modalQuantity" value="1" min="1" />
                            <button class="qty-btn" onclick="changeQuantity(1)">+</button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes/Remarks</label>
                            <textarea class="form-input" id="productNotes" rows="3" placeholder="Add any special notes..."></textarea>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%;" onclick="addProductToCart()">
                            Add to Cart
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Select variant
        function selectVariant(variantId) {
            if (!currentProduct || !currentProduct.variants) return;
            
            const variant = currentProduct.variants.find(v => v.id === variantId);
            if (!variant || variant.stock === 0) return;
            
            currentVariant = variant;
            
            document.querySelectorAll('.variant-option').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`variant-${variantId}`).classList.add('active');
            
            document.getElementById('variantDetails').style.display = 'block';
            document.getElementById('regularPriceDisplay').textContent = formatCurrency(variant.regularPrice);
            document.getElementById('wholesalePriceDisplay').textContent = formatCurrency(variant.wholesalePrice);
            document.getElementById('modalQuantity').value = 1;
        }

        // Select price type
        function selectPriceType(type) {
            document.querySelectorAll('.price-option').forEach(option => {
                option.classList.remove('active');
            });
            document.getElementById(type + 'Option').classList.add('active');
        }

        // Change quantity
        function changeQuantity(delta) {
            const quantityEl = document.getElementById('modalQuantity');
            let quantity = parseInt(quantityEl.value) + delta;
            if (quantity < 1) quantity = 1;
            if (currentVariant && quantity > currentVariant.stock) {
                quantity = currentVariant.stock;
                alert(`Only ${currentVariant.stock} items available!`);
            }
            quantityEl.value = quantity;
        }

        // Add product to cart
        function addProductToCart() {
            if (!currentVariant) {
                alert('Please select a variant first!');
                return;
            }
            
            const quantity = parseInt(document.getElementById('modalQuantity').value);
            const notes = document.getElementById('productNotes').value;
            const priceType = document.querySelector('.price-option.active').id === 'regularOption' ? 'regular' : 'wholesale';
            const price = priceType === 'regular' ? currentVariant.regularPrice : currentVariant.wholesalePrice;
            
            if (quantity > currentVariant.stock) {
                alert(`Only ${currentVariant.stock} items available!`);
                return;
            }
            
            const cartItem = {
                productId: currentProduct.id,
                productName: currentProduct.name,
                variantId: currentVariant.id,
                variantName: currentVariant.name,
                quantity,
                notes,
                priceType,
                unitPrice: price,
                costPrice: currentVariant.costPrice,
                totalPrice: price * quantity
            };
            
            if (editingCartIndex !== null) {
                cart[editingCartIndex] = cartItem;
                editingCartIndex = null;
            } else {
                cart.push(cartItem);
            }
            
            updateCartDisplay();
            closeModal('productModal');
        }
            // Update cart display with profit calculation
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Cart is empty</div>';
                cartTotal.style.display = 'none';
                checkoutBtn.disabled = true;
                return;
            }
            
            cartTotal.style.display = 'block';
            checkoutBtn.disabled = false;
            
            let total = 0;
            let totalProfit = 0;
            
            cartItems.innerHTML = cart.map((item, index) => {
                total += item.totalPrice;
                const profit = (item.unitPrice - item.costPrice) * item.quantity;
                totalProfit += profit;
                
                return `
                    <div class="cart-item">
                        <div>
                            <div class="cart-item-name" onclick="editCartItem(${index})">${item.productName} - ${item.variantName}</div>
                            <div style="font-size: 12px; color: #666;">
                                ${item.priceType} × ${item.quantity}
                                ${item.notes ? `<br><em>${item.notes}</em>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="font-weight: 600; color: #e91e63; margin-right: 10px;">
                                ${formatCurrency(item.totalPrice)}
                            </div>
                            <button style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;" 
                                    onclick="removeFromCart(${index})">×</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('total').textContent = formatCurrency(total);
            document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
        }
        
        // Edit cart item
        function editCartItem(index) {
            const cartItem = cart[index];
            const product = products.find(p => p.id === cartItem.productId);
            if (!product) return;
            
            editingCartIndex = index;
            currentProduct = product;
            currentVariant = product.variants.find(v => v.id === cartItem.variantId);
            
            const modal = document.getElementById('productModal');
            const content = document.getElementById('productModalContent');
            
            content.innerHTML = `
                <div>
                    <div style="text-align: center; margin-bottom: 20px;">
                        ${product.image 
                            ? `<img src="${product.image}" style="max-width: 150px; max-height: 150px; border-radius: 10px;" />`
                            : `<div style="font-size: 60px;">📦</div>`
                        }
                        <h3 style="margin-top: 10px;">${product.name}</h3>
                        <div style="color: #e91e63; font-weight: 600; margin-top: 5px;">Editing Cart Item</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Select Variant</label>
                        <div class="variant-selector">
                            ${product.variants.map(variant => `
                                <div class="variant-option ${variant.stock === 0 ? 'out-of-stock' : ''} ${variant.id === cartItem.variantId ? 'active' : ''}" 
                                     onclick="${variant.stock > 0 ? `selectVariant('${variant.id}')` : ''}"
                                     id="variant-${variant.id}">
                                    <div class="variant-name">${variant.name}</div>
                                    <div class="variant-price">
                                        Regular: ${formatCurrency(variant.regularPrice)} | 
                                        Wholesale: ${formatCurrency(variant.wholesalePrice)}
                                    </div>
                                    <div class="variant-stock ${variant.stock === 0 ? 'stock-badge out' : variant.stock <= product.lowStockThreshold ? 'stock-badge low' : 'stock-badge normal'}">
                                        ${variant.stock === 0 ? 'OUT OF STOCK' : `${variant.stock} available`}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="variantDetails" style="display: block;">
                        <div class="price-toggle">
                            <div class="price-option ${cartItem.priceType === 'regular' ? 'active' : ''}" onclick="selectPriceType('regular')" id="regularOption">
                                <div style="font-weight: 600; margin-bottom: 5px;">Regular</div>
                                <div style="font-size: 1.2em; color: #e91e63; font-weight: bold;" id="regularPriceDisplay">${formatCurrency(currentVariant.regularPrice)}</div>
                            </div>
                            <div class="price-option ${cartItem.priceType === 'wholesale' ? 'active' : ''}" onclick="selectPriceType('wholesale')" id="wholesaleOption">
                                <div style="font-weight: 600; margin-bottom: 5px;">Wholesale</div>
                                <div style="font-size: 1.2em; color: #e91e63; font-weight: bold;" id="wholesalePriceDisplay">${formatCurrency(currentVariant.wholesalePrice)}</div>
                            </div>
                        </div>
                        
                        <div class="quantity-selector">
                            <button class="qty-btn" onclick="changeQuantity(-1)">-</button>
                            <input type="number" class="qty-display" id="modalQuantity" value="${cartItem.quantity}" min="1" />
                            <button class="qty-btn" onclick="changeQuantity(1)">+</button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Notes/Remarks</label>
                            <textarea class="form-input" id="productNotes" rows="3" placeholder="Add any special notes...">${cartItem.notes || ''}</textarea>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%;" onclick="addProductToCart()">
                            Update Cart Item
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Remove from cart
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        }

        // Clear cart
        function clearCart() {
            cart = [];
            updateCartDisplay();
        }

        // Show checkout
        function showCheckout() {
            if (cart.length === 0) return;
            
            const modal = document.getElementById('checkoutModal');
            const receiptPreview = document.getElementById('receiptPreview');
            const checkoutTotal = document.getElementById('checkoutTotal');
            
            let total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            let totalProfit = cart.reduce((sum, item) => sum + ((item.unitPrice - item.costPrice) * item.quantity), 0);
            
            checkoutTotal.textContent = formatCurrency(total);
            
            receiptPreview.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <strong>FAMILY CAKE</strong><br>
                    Receipt
                </div>
                <div style="margin-bottom: 15px;">
                    Date: ${new Date().toLocaleString()}<br>
                    ${selectedCustomer ? `Customer: ${selectedCustomer.name}<br>` : ''}
                    ${selectedCustomer && selectedCustomer.phone ? `Phone: ${selectedCustomer.phone}<br>` : ''}
                </div>
                <div style="border-bottom: 1px dashed #333; margin-bottom: 10px;"></div>
                ${cart.map(item => `
                    <div style="margin-bottom: 8px;">
                        ${item.productName} - ${item.variantName}<br>
                        ${item.quantity} × ${formatCurrency(item.unitPrice)} = ${formatCurrency(item.totalPrice)}
                        ${item.notes ? `<br><em>${item.notes}</em>` : ''}
                    </div>
                `).join('')}
                <div style="border-bottom: 1px dashed #333; margin: 10px 0;"></div>
                <div style="text-align: right; font-weight: bold;">
                    TOTAL: ${formatCurrency(total)}
                </div>
                <div style="text-align: right; color: #28a745; margin-top: 10px;">
                    Profit: ${formatCurrency(totalProfit)}
                </div>
            `;
            
            document.getElementById('amountReceived').value = '';
            modal.style.display = 'block';
        }

        // Process payment with profit tracking
        function processPayment() {
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            const amountReceived = parseInt(document.getElementById('amountReceived').value) || 0;
            
            if (amountReceived < total) {
                alert('Amount received is less than total!');
                return;
            }
            
            // Reduce stock and log sales with profit
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.productId);
                const variant = product?.variants?.find(v => v.id === cartItem.variantId);
                
                if (variant) {
                    variant.stock -= cartItem.quantity;
                    logStockMovement(
                        cartItem.productId,
                        cartItem.variantId,
                        'sale',
                        cartItem.quantity,
                        variant.stock,
                        `Sale - ${cartItem.priceType} price`,
                        variant.costPrice,
                        cartItem.totalPrice
                    );
                }
            });
            
            saveProducts();
            
            const change = amountReceived - total;

            // Check device type and offer appropriate print option
            if (/Android/i.test(navigator.userAgent)) {
                // Android device detected
                const printConfirm = confirm(`Transaction Complete!\nTotal: ${formatCurrency(total)}\nReceived: ${formatCurrency(amountReceived)}\nChange: ${formatCurrency(change)}\n\nPrint receipt via Bluetooth?`);
    
                if (printConfirm) {
                    printReceiptBluetooth();
                }
            } else {
                // Desktop or iOS
                const printConfirm = confirm(`Transaction Complete!\nTotal: ${formatCurrency(total)}\nReceived: ${formatCurrency(amountReceived)}\nChange: ${formatCurrency(change)}\n\nPrint receipt?`);
    
                if (printConfirm) {
                    printReceipt(); // Use regular print dialog
                }
            }
            
            cart = [];
            updateCartDisplay();
            selectedCustomer = null;
            document.getElementById('customerInput').value = '';
            document.getElementById('selectedCustomerInfo').style.display = 'none';
            updateProductGrid();
            closeModal('checkoutModal');
        }

        // Receipt printing functions
        function printReceipt() {
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
            const receiptContent = `
                <html>
                <head>
                    <title>Receipt</title>
                    <style>
                        body { font-family: monospace; width: 58mm; margin: 0 auto; padding: 10px; }
                        h2 { text-align: center; font-size: 16px; margin: 10px 0; }
                        .divider { border-bottom: 1px dashed #000; margin: 10px 0; }
                        .item { margin: 8px 0; font-size: 12px; }
                        .total { font-weight: bold; font-size: 14px; text-align: right; margin-top: 10px; }
                        .center { text-align: center; }
                        .info { font-size: 11px; margin: 5px 0; }
                    </style>
                </head>
                <body>
                    <h2>FAMILY CAKE</h2>
                    <div class="center info">*** RECEIPT ***</div>
                    <div class="info">Date: ${new Date().toLocaleString()}</div>
                    ${selectedCustomer ? `<div class="info">Customer: ${selectedCustomer.name}</div>` : ''}
                    ${selectedCustomer && selectedCustomer.phone ? `<div class="info">Phone: ${selectedCustomer.phone}</div>` : ''}
                    <div class="divider"></div>
                    ${cart.map(item => `
                        <div class="item">
                            <div>${item.productName} - ${item.variantName}</div>
                            <div>${item.quantity} x ${formatCurrency(item.unitPrice)} = ${formatCurrency(item.totalPrice)}</div>
                            ${item.notes ? `<div style="font-size: 10px; font-style: italic;">${item.notes}</div>` : ''}
                        </div>
                    `).join('')}
                    <div class="divider"></div>
                    <div class="total">TOTAL: ${formatCurrency(total)}</div>
                    <div class="divider"></div>
                    <div class="center info">Thank you for your purchase!</div>
                </body>
                </html>
            `;
    
            const printWindow = window.open('', '', 'width=300,height=600');
            printWindow.document.write(receiptContent);
            printWindow.document.close();
            printWindow.print();
            printWindow.close();
        }

        function printReceiptBluetooth() {
            const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    
            // Format receipt for thermal printer
            let receiptText = "";
            receiptText += "      FAMILY CAKE\n";
            receiptText += "      RECEIPT\n";
            receiptText += "------------------------\n";
            receiptText += `Date: ${new Date().toLocaleString()}\n`;
    
            if (selectedCustomer) {
                receiptText += `Customer: ${selectedCustomer.name}\n`;
                if (selectedCustomer.phone) {
                    receiptText += `Phone: ${selectedCustomer.phone}\n`;
                }
            }
    
            receiptText += "------------------------\n";
    
            cart.forEach(item => {
                receiptText += `${item.productName}-${item.variantName}\n`;
                receiptText += `  ${item.quantity} x ${item.unitPrice} = ${item.totalPrice}\n`;
                if (item.notes) {
                    receiptText += `  Note: ${item.notes}\n`;
                }
            });
    
            receiptText += "------------------------\n";
            receiptText += `TOTAL: ${formatCurrency(total)}\n`;
            receiptText += "------------------------\n";
            receiptText += "  Thank you!\n\n\n";
    
            // For RawBT app (Android)
            const url = `intent://rawbt#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;S.text=${encodeURIComponent(receiptText)};end;`;
            window.location.href = url;
        }

        // Show add product modal
        function showAddProductModal() {
            editingProductId = null;
            document.getElementById('productEditTitle').textContent = 'Add New Product';
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = 'family-cake';
            document.getElementById('lowStockThreshold').value = '5';
            
            // Update supplier dropdown
            const supplierSelect = document.getElementById('productSupplier');
            supplierSelect.innerHTML = suppliers.map(s => 
                `<option value="${s.id}">${s.name}</option>`
            ).join('');
            
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '<span style="color: #999;">No image</span>';
            preview.dataset.imageData = '';
            
            document.getElementById('variantsList').innerHTML = '';
            document.getElementById('imageInput').value = '';
            variantCounter = 0;
            
            addVariantForm();
            
            document.getElementById('productEditModal').style.display = 'block';
        }

        // Add variant form with cost price
        function addVariantForm() {
            variantCounter++;
            const variantsList = document.getElementById('variantsList');
            
            const variantForm = document.createElement('div');
            variantForm.className = 'variant-form';
            variantForm.id = `variant-form-${variantCounter}`;
            variantForm.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>Variant ${variantCounter}</strong>
                    <button class="btn btn-danger btn-sm" onclick="removeVariantForm(${variantCounter})">Remove</button>
                </div>
                <div class="variant-grid">
                    <div>
                        <input type="text" class="form-input" placeholder="Variant name" id="variant-name-${variantCounter}" />
                    </div>
                    <div>
                        <input type="number" class="form-input" placeholder="Cost price" id="variant-cost-${variantCounter}" />
                    </div>
                    <div>
                        <input type="number" class="form-input" placeholder="Regular price" id="variant-regular-${variantCounter}" />
                    </div>
                    <div>
                        <input type="number" class="form-input" placeholder="Wholesale price" id="variant-wholesale-${variantCounter}" />
                    </div>
                    <div>
                        <input type="number" class="form-input" placeholder="Initial stock" id="variant-stock-${variantCounter}" value="0" />
                    </div>
                </div>
            `;
            
            variantsList.appendChild(variantForm);
        }

        // Remove variant form
        function removeVariantForm(id) {
            const form = document.getElementById(`variant-form-${id}`);
            if (form) form.remove();
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 200000) {
                alert('Image size should be less than 200KB for optimal performance');
                event.target.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${imageData}" style="width: 100%; height: 100%; object-fit: cover;" />`;
                preview.dataset.imageData = imageData;
                console.log('Image uploaded successfully, size:', Math.round(imageData.length / 1024), 'KB');
            };
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
                event.target.value = '';
            };
            reader.readAsDataURL(file);
        }

        // Save product with COGS
        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            if (!name) {
                alert('Please enter a product name');
                return;
            }
            
            const category = document.getElementById('productCategory').value;
            const supplierSelect = document.getElementById('productSupplier');
            const supplierIds = Array.from(supplierSelect.selectedOptions).map(option => parseInt(option.value));
            const lowStockThreshold = parseInt(document.getElementById('lowStockThreshold').value) || 5;
            
            const preview = document.getElementById('imagePreview');
            const image = preview.dataset.imageData || null;
            
            const variants = [];
            const variantForms = document.querySelectorAll('.variant-form');
            
            for (let form of variantForms) {
                const id = form.id.split('-')[2];
                const variantName = document.getElementById(`variant-name-${id}`).value.trim();
                const costPrice = parseInt(document.getElementById(`variant-cost-${id}`).value) || 0;
                const stock = parseInt(document.getElementById(`variant-stock-${id}`).value) || 0;
                const regularPrice = parseInt(document.getElementById(`variant-regular-${id}`).value) || 0;
                const wholesalePrice = parseInt(document.getElementById(`variant-wholesale-${id}`).value) || 0;
                
                if (variantName && regularPrice > 0 && wholesalePrice > 0 && costPrice > 0) {
                    variants.push({
                        id: `v${Date.now()}-${id}`,
                        name: variantName,
                        stock: stock,
                        costPrice: costPrice,
                        regularPrice: regularPrice,
                        wholesalePrice: wholesalePrice
                    });
                }
            }
            
            if (variants.length === 0) {
                alert('Please add at least one variant with valid prices');
                return;
            }
            
            const newProduct = {
                id: editingProductId || Date.now(),
                name: name,
                category: category,
                lowStockThreshold: lowStockThreshold,
                supplierIds: supplierIds,
                image: image,
                variants: variants
            };
            
            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    const oldProduct = products[index];
                    const updatedVariants = variants.map((newVar, idx) => {
                        const oldVar = oldProduct.variants.find(v => v.name === newVar.name) || oldProduct.variants[idx];
                        return {
                            ...newVar,
                            id: oldVar ? oldVar.id : newVar.id
                        };
                    });
                    newProduct.variants = updatedVariants;
                    products[index] = newProduct;
                }
            } else {
                products.push(newProduct);
            }
            
            saveProducts();
            updateProductsList();
            updateProductGrid();
            updateInventoryDisplay();
            closeModal('productEditModal');
            
            const successMsg = editingProductId ? 'Product updated successfully!' : 'Product added successfully!';
            alert(successMsg + (image ? ' (with image)' : ' (no image)'));
        }
            // Update products list in management tab
        function updateProductsList() {
            const productsList = document.getElementById('productsList');
            
            productsList.innerHTML = products.map(product => {
                const variants = Array.isArray(product.variants) ? product.variants : [];
                const productSuppliers = suppliers.filter(s => 
                    (product.supplierIds || []).includes(s.id) || 
                    (product.supplierId && s.id === product.supplierId) 
                );
                const supplierNames = productSuppliers.map(s => s.name).join(', ');

                return `
                <div class="product-management-card">
                    <div class="product-header">
                        <div class="product-thumb">
                            ${product.image 
                                ? `<img src="${product.image}" />`
                                : `<span style="font-size: 24px;">📦</span>`
                            }
                        </div>
                        <div style="flex: 1;">
                            <h4>${product.name}</h4>
                            <div style="font-size: 12px; color: #666;">
                                Category: ${product.category} | ${variants.length} variants
                                ${supplierNames ? ` | Suppliers: ${supplierNames}` : ' | No suppliers assigned'}
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="editProduct(${product.id})">Edit</button>
                    </div>
                    <div class="variant-list">
                        ${variants.map(variant => {
                            const profit = variant.regularPrice - variant.costPrice;
                            const profitMargin = ((profit / variant.regularPrice) * 100).toFixed(1);
                            return `
                            <div class="variant-item">
                                <div>
                                    <strong>${variant.name}</strong>
                                    <div style="font-size: 12px; color: #666;">
                                        Cost: ${formatCurrency(variant.costPrice)} | 
                                        R: ${formatCurrency(variant.regularPrice)} | 
                                        W: ${formatCurrency(variant.wholesalePrice)}
                                    </div>
                                    <div style="font-size: 11px; color: #28a745;">
                                        Profit: ${formatCurrency(profit)} (${profitMargin}%)
                                    </div>
                                </div>
                                <div class="variant-actions">
                                    <span class="stock-badge ${variant.stock === 0 ? 'out' : variant.stock <= product.lowStockThreshold ? 'low' : 'normal'}">
                                        Stock: ${variant.stock}
                                    </span>
                                    <button class="btn btn-success btn-sm" onclick="adjustStock(${product.id}, '${variant.id}')">
                                        Adjust
                                    </button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `}).join('');
        }

        // Edit product
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            editingProductId = productId;
            document.getElementById('productEditTitle').textContent = 'Edit Product';
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('lowStockThreshold').value = product.lowStockThreshold;
            
            // Update supplier dropdown
            const supplierSelect = document.getElementById('productSupplier');
            const productSupplierIds = product.supplierIds || (product.supplierId ? [product.supplierId] : []);
            supplierSelect.innerHTML = suppliers.map(s => 
                `<option value="${s.id}" ${productSupplierIds.includes(s.id) ? 'selected' : ''}>${s.name}</option>`
            ).join('');
            
            const preview = document.getElementById('imagePreview');
            if (product.image) {
                preview.innerHTML = `<img src="${product.image}" style="width: 100%; height: 100%; object-fit: cover;" />`;
                preview.dataset.imageData = product.image;
            } else {
                preview.innerHTML = '<span style="color: #999;">No image</span>';
                preview.dataset.imageData = '';
            }
            
            document.getElementById('imageInput').value = '';
            document.getElementById('variantsList').innerHTML = '';
            variantCounter = 0;
            
            const variants = Array.isArray(product.variants) ? product.variants : [];
            variants.forEach(variant => {
                variantCounter++;
                const variantForm = document.createElement('div');
                variantForm.className = 'variant-form';
                variantForm.id = `variant-form-${variantCounter}`;
                variantForm.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>Variant ${variantCounter}</strong>
                        <button class="btn btn-danger btn-sm" onclick="removeVariantForm(${variantCounter})">Remove</button>
                    </div>
                    <div class="variant-grid">
                        <div>
                            <input type="text" class="form-input" placeholder="Variant name" id="variant-name-${variantCounter}" value="${variant.name}" />
                        </div>
                        <div>
                            <input type="number" class="form-input" placeholder="Cost price" id="variant-cost-${variantCounter}" value="${variant.costPrice}" />
                        </div>
                        <div>
                            <input type="number" class="form-input" placeholder="Regular price" id="variant-regular-${variantCounter}" value="${variant.regularPrice}" />
                        </div>
                        <div>
                            <input type="number" class="form-input" placeholder="Wholesale price" id="variant-wholesale-${variantCounter}" value="${variant.wholesalePrice}" />
                        </div>
                        <div>
                            <input type="number" class="form-input" placeholder="Initial stock" id="variant-stock-${variantCounter}" value="${variant.stock}" />
                        </div>
                    </div>
                `;
                document.getElementById('variantsList').appendChild(variantForm);
            });
            
            document.getElementById('productEditModal').style.display = 'block';
        }

        // Adjust stock
        function adjustStock(productId, variantId) {
            const product = products.find(p => p.id === productId);
            const variant = product?.variants?.find(v => v.id === variantId);
            
            if (!product || !variant) return;
            
            const modal = document.getElementById('stockModal');
            const content = document.getElementById('stockModalContent');
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <h4>${product.name} - ${variant.name}</h4>
                    <div style="margin: 20px 0;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #e91e63;">
                            Current Stock: ${variant.stock}
                        </div>
                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                            Cost: ${formatCurrency(variant.costPrice)} | Sell: ${formatCurrency(variant.regularPrice)}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Adjustment Type</label>
                        <select class="form-select" id="adjustmentType">
                            <option value="add">Add Stock</option>
                            <option value="remove">Remove Stock</option>
                            <option value="set">Set Exact Stock</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-input" id="adjustmentQuantity" min="0" value="1" />
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Reason/Notes</label>
                        <textarea class="form-input" id="adjustmentReason" rows="3" placeholder="Reason for adjustment..."></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn btn-secondary" onclick="closeModal('stockModal')">Cancel</button>
                        <button class="btn btn-primary" onclick="processStockAdjustment(${productId}, '${variantId}')">Apply</button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Process stock adjustment
        function processStockAdjustment(productId, variantId) {
            const product = products.find(p => p.id === productId);
            const variant = product?.variants?.find(v => v.id === variantId);
            
            if (!product || !variant) return;
            
            const type = document.getElementById('adjustmentType').value;
            const quantity = parseInt(document.getElementById('adjustmentQuantity').value) || 0;
            const reason = document.getElementById('adjustmentReason').value || 'Manual adjustment';
            
            let newStock = variant.stock;
            
            switch(type) {
                case 'add':
                    newStock = variant.stock + quantity;
                    break;
                case 'remove':
                    newStock = Math.max(0, variant.stock - quantity);
                    break;
                case 'set':
                    newStock = Math.max(0, quantity);
                    break;
            }
            
            variant.stock = newStock;
            logStockMovement(productId, variantId, type, quantity, newStock, reason, variant.costPrice, 0);
            
            saveProducts();
            updateInventoryDisplay();
            updateProductsList();
            updateProductGrid();
            closeModal('stockModal');
            
            alert(`Stock updated! ${product.name} - ${variant.name} now has ${newStock} items.`);
        }
        // Update inventory display
        function updateInventoryDisplay() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            
            inventoryGrid.innerHTML = products.map(product => {
                const variants = Array.isArray(product.variants) ? product.variants : [];
                const hasLowStock = variants.some(v => v.stock > 0 && v.stock <= product.lowStockThreshold);
                const hasOutOfStock = variants.some(v => v.stock === 0);
                const productSuppliers = suppliers.filter(s => 
                    (product.supplierIds || []).includes(s.id) || 
                    (product.supplierId && s.id === product.supplierId)
            );
                const supplierNames = productSuppliers.map(s => s.name).join(', ');
                let cardClass = '';
                if (hasOutOfStock) cardClass = 'out-of-stock';
                else if (hasLowStock) cardClass = 'low-stock';
                
                // Calculate total value
                const totalValue = variants.reduce((sum, v) => sum + (v.stock * v.costPrice), 0);
                
                return `
                    <div class="inventory-card ${cardClass}">
                        <div class="product-header">
                            <div class="product-thumb">
                                ${product.image 
                                    ? `<img src="${product.image}" />`
                                    : `<span style="font-size: 24px;">📦</span>`
                                }
                            </div>
                            <div style="flex: 1;">
                                <h4>${product.name}</h4>
                                <div style="font-size: 12px; color: #666;">
                                    ${product.category} | ${variants.length} variants
                                    ${supplierNames ? ` | ${supplierNames}` : ''}
                                </div>
                                <div style="font-size: 11px; color: #e91e63; margin-top: 5px;">
                                    Total Value: ${formatCurrency(totalValue)}
                                </div>
                            </div>
                        </div>
                        <div class="variant-list">
                            ${variants.map(variant => `
                                <div class="variant-item">
                                    <div>
                                        <strong>${variant.name}</strong>
                                        <div style="font-size: 11px; color: #666;">
                                            Cost: ${formatCurrency(variant.costPrice)} | 
                                            R: ${formatCurrency(variant.regularPrice)} | 
                                            W: ${formatCurrency(variant.wholesalePrice)}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span class="stock-badge ${variant.stock === 0 ? 'out' : variant.stock <= product.lowStockThreshold ? 'low' : 'normal'}">
                                            ${variant.stock}
                                        </span>
                                        <button class="btn btn-primary btn-sm" onclick="adjustStock(${product.id}, '${variant.id}')">
                                            Adjust
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update stock log display with profit
        function updateStockLogDisplay(startDate, endDate) {
            const logBody = document.getElementById('stockLogBody');

            // Filter movements by the selected date range
            const filteredMovements = stockMovements.filter(m => {
                const moveDate = new Date(m.timestamp);
                return moveDate >= startDate && moveDate <= endDate;
            });

            if (filteredMovements.length === 0) {
                logBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            No stock movements recorded for this period
                        </td>
                    </tr>
                `;
                return;
            }

            logBody.innerHTML = filteredMovements.slice(0, 100).map(movement => { // Show up to 100 entries for the period
                const date = new Date(movement.timestamp);
                const typeColors = {
                    'sale': '#dc3545', 'add': '#28a745', 'remove': '#ffc107',
                    'set': '#17a2b8', 'purchase': '#007bff', 'waste': '#6c757d'
                };

                return `
                    <tr>
                        <td style="padding: 10px;">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>
                        <td style="padding: 10px;">${movement.productName}</td>
                        <td style="padding: 10px;">${movement.variantName}</td>
                        <td style="padding: 10px; color: ${typeColors[movement.type] || '#333'}; font-weight: 600;">
                            ${movement.type}
                        </td>
                        <td style="padding: 10px; font-weight: 600;">${movement.quantity}</td>
                        <td style="padding: 10px;">${formatCurrency((movement.cost || 0) * movement.quantity)}</td>
                        <td style="padding: 10px; color: ${movement.profit >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">
                            ${movement.type === 'sale' ? formatCurrency(movement.profit || 0) : '-'}
                        </td>
                        <td style="padding: 10px; font-weight: 600;">${movement.newStock}</td>
                    </tr>
                `;
            }).join('');
        }

        // Filter products
        function filterProducts(filter, event) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                if (filter === 'all' || card.classList.contains(filter)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Close modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Tab switching
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load appropriate content
            if (tabName === 'products') {
                updateProductsList();
            } else if (tabName === 'inventory') {
                updateInventoryDisplay();
            } else if (tabName === 'pos') {
                updateProductGrid();
            } else if (tabName === 'reports') {
                // Set today as default
                reportStartDate = new Date();
                reportStartDate.setHours(0, 0, 0, 0);
                reportEndDate = new Date();
                reportEndDate.setHours(23, 59, 59, 999);
                
                updateReportView(reportStartDate, reportEndDate);
            } else if (tabName === 'suppliers') {
                updateSuppliersList();
            } else if (tabName === 'purchase-orders') {
                updatePurchaseOrdersList();
            } else if (tabName === 'customers') {
                updateCustomersList();
            } else if (tabName === 'finance') {
                showFinanceSection('cash-register');
                initializeFinance();
            } else if (tabName === 'finance') {
                showFinanceSection('cash-register');
                initializeFinance();
            } else if (tabName === 'staff') {  
                if (loggedInUser && loggedInUser.role === 'owner') {
                    updateUsersList();
                }
            }

        }
        // Supplier Management Functions
        function showAddSupplierModal() {
            editingSupplierId = null;
            
            const modalHtml = `
                <div id="supplierModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('supplierModal')">&times;</span>
                        <h3>Add New Supplier</h3>
                        <div class="form-group">
                            <label class="form-label">Supplier Name</label>
                            <input type="text" class="form-input" id="supplierName" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Number</label>
                            <input type="text" class="form-input" id="supplierContact" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="supplierEmail" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-input" id="supplierAddress" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Terms</label>
                            <select class="form-select" id="supplierPaymentTerms">
                                <option value="COD">Cash on Delivery</option>
                                <option value="Net 7">Net 7 Days</option>
                                <option value="Net 15">Net 15 Days</option>
                                <option value="Net 30">Net 30 Days</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeModal('supplierModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveSupplier()">Save Supplier</button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('supplierModal');
            if (existingModal) existingModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function saveSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            const contact = document.getElementById('supplierContact').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const address = document.getElementById('supplierAddress').value.trim();
            const paymentTerms = document.getElementById('supplierPaymentTerms').value;
            
            if (!name) {
                alert('Please enter supplier name');
                return;
            }
            
            const newSupplier = {
                id: editingSupplierId || Date.now(),
                name: name,
                contact: contact,
                email: email,
                address: address,
                paymentTerms: paymentTerms,
                outstandingBalance: 0
            };
            
            if (editingSupplierId) {
                const index = suppliers.findIndex(s => s.id === editingSupplierId);
                if (index !== -1) {
                    suppliers[index] = {...suppliers[index], ...newSupplier};
                }
            } else {
                suppliers.push(newSupplier);
            }
            
            saveProducts();
            updateSuppliersList();
            closeModal('supplierModal');
            alert(editingSupplierId ? 'Supplier updated successfully!' : 'Supplier added successfully!');
        }

        // Customer Management Functions
        function initializeCustomers() {
            const savedCustomers = localStorage.getItem('familyCakeCustomers');
            if (savedCustomers) {
                customers = JSON.parse(savedCustomers);
            } else {
                // Sample customers
                customers = [
                    {
                        id: 1,
                        name: 'John Doe',
                        phone: '09-123456789',
                        address: '123 Main St, Yangon',
                        email: 'john@example.com'
                    },
                    {
                        id: 2,
                        name: 'Jane Smith',
                        phone: '09-987654321',
                        address: '456 Oak Ave, Mandalay',
                        email: 'jane@example.com'
                    }
                ];
                saveCustomers();
            }
        }

        function saveCustomers() {
            localStorage.setItem('familyCakeCustomers', JSON.stringify(customers));
        }

        function showAddCustomerModal(customerId = null) {
            const customer = customerId ? customers.find(c => c.id === customerId) : null;
    
            const modalHtml = `
                <div id="customerModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('customerModal')">&times;</span>
                        <h3>${customer ? 'Edit Customer' : 'Add New Customer'}</h3>
                        <div class="form-group">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-input" id="customerName" value="${customer ? customer.name : ''}" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="text" class="form-input" id="customerPhone" value="${customer ? customer.phone : ''}" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-input" id="customerEmail" value="${customer ? customer.email : ''}" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-input" id="customerAddress" rows="3">${customer ? customer.address : ''}</textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveCustomer(${customer ? customer.id : 'null'})">Save Customer</button>
                        </div>
                    </div>
                </div>
            `;
    
            const existingModal = document.getElementById('customerModal');
            if (existingModal) existingModal.remove();
    
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function saveCustomer(customerId) {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
    
            if (!name || !phone) {
                alert('Please enter customer name and phone number');
                return;
            }
    
            if (customerId) {
                const index = customers.findIndex(c => c.id === customerId);
                if (index !== -1) {
                    customers[index] = {
                        id: customerId,
                        name: name,
                        phone: phone,
                        email: email,
                        address: address
                    };
                }
            } else {
                customers.push({
                    id: Date.now(),
                    name: name,
                    phone: phone,
                    email: email,
                    address: address
                });
            }
    
            saveCustomers();
            updateCustomersList();
            closeModal('customerModal');
            alert(customerId ? 'Customer updated successfully!' : 'Customer added successfully!');
        }

        function deleteCustomer(customerId) {
        if (!confirm('Are you sure you want to delete this customer?')) return;
    
        customers = customers.filter(c => c.id !== customerId);
        saveCustomers();
        updateCustomersList();
        }

        function updateCustomersList() {
            const customersList = document.getElementById('customersList');
    
            if (customers.length === 0) {
                customersList.innerHTML = '<p style="text-align: center; color: #666;">No customers added yet</p>';
                return;
            }
    
            customersList.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    ${customers.map(customer => `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: 10px;">${customer.name}</h4>
                                    <div style="display: grid; gap: 5px; font-size: 14px; color: #666;">
                                        <div><strong>Phone:</strong> ${customer.phone}</div>
                                        ${customer.email ? `<div><strong>Email:</strong> ${customer.email}</div>` : ''}
                                        ${customer.address ? `<div><strong>Address:</strong> ${customer.address}</div>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary btn-sm" onclick="showAddCustomerModal(${customer.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Customer Search/Autocomplete Functions
        function handleCustomerSearch(event) {
            const input = event.target;
            const searchTerm = input.value.toLowerCase().trim();
            const suggestionsDiv = document.getElementById('customerSuggestions');
    
            // Handle arrow keys and enter
            if (event.key === 'ArrowDown') {
                currentSuggestionIndex++;
                highlightSuggestion();
                return;
            } else if (event.key === 'ArrowUp') {
                currentSuggestionIndex--;
                highlightSuggestion();
                return;
            } else if (event.key === 'Enter') {
                selectHighlightedSuggestion();
                return;
            } else if (event.key === 'Escape') {
                hideSuggestions();
                return;
            }
    
            if (searchTerm.length === 0) {
                selectedCustomer = null;
                document.getElementById('selectedCustomerInfo').style.display = 'none';
                showCustomerSuggestions();
                return;
            }
    
            // Filter customers based on search term (searches anywhere in name)
            const matchedCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm)
            );
    
            // Add Walk-in option if it matches
            if ('walk-in'.includes(searchTerm) || 'walk in'.includes(searchTerm)) {
                matchedCustomers.unshift({
                    id: 'walk-in',
                    name: 'Walk-in Customer',
                    phone: ''
                });
            }
    
            displaySuggestions(matchedCustomers);
        }

        function showCustomerSuggestions() {
            const input = document.getElementById('customerInput');
            const searchTerm = input.value.toLowerCase().trim();
    
            if (searchTerm.length === 0) {
                // Show all customers plus walk-in option
                const allOptions = [
                    { id: 'walk-in', name: 'Walk-in Customer', phone: '' },
                    ...customers.slice(0, 10) // Show max 10 customers initially
                ];
                displaySuggestions(allOptions);
            }
        }

        function displaySuggestions(matchedCustomers) {
            const suggestionsDiv = document.getElementById('customerSuggestions');
    
            if (matchedCustomers.length === 0) {
                suggestionsDiv.innerHTML = '<div style="padding: 10px; color: #666;">No customers found</div>';
                suggestionsDiv.style.display = 'block';
                return;
            }
    
            currentSuggestionIndex = -1;
            suggestionsDiv.innerHTML = matchedCustomers.slice(0, 10).map((customer, index) => `
                <div class="customer-suggestion" 
                    data-index="${index}"
                    onclick="selectCustomer(${typeof customer.id === 'string' ? `'${customer.id}'` : customer.id})"
                    onmouseover="currentSuggestionIndex = ${index}; highlightSuggestion();"
                    style="padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                    <div style="font-weight: 600;">${customer.name}</div>
                    ${customer.phone ? `<div style="font-size: 12px; color: #666;">${customer.phone}</div>` : ''}
                </div>
            `).join('');
    
            suggestionsDiv.style.display = 'block';
        }

        function highlightSuggestion() {
            const suggestions = document.querySelectorAll('.customer-suggestion');
            suggestions.forEach((s, index) => {
                if (index === currentSuggestionIndex) {
                    s.style.background = '#f0f0f0';
                } else {
                    s.style.background = 'white';
                }
            });
        }

        function selectHighlightedSuggestion() {
            const suggestions = document.querySelectorAll('.customer-suggestion');
            if (currentSuggestionIndex >= 0 && currentSuggestionIndex < suggestions.length) {
                suggestions[currentSuggestionIndex].click();
            }
        }

        function selectCustomer(customerId) {
            const input = document.getElementById('customerInput');
            const infoDiv = document.getElementById('selectedCustomerInfo');
    
            if (customerId === 'walk-in') {
                selectedCustomer = { id: 'walk-in', name: 'Walk-in Customer', phone: '' };
                input.value = 'Walk-in Customer';
                infoDiv.style.display = 'none';
            } else {
                selectedCustomer = customers.find(c => c.id === customerId);
                if (selectedCustomer) {
                    input.value = selectedCustomer.name;
                    infoDiv.innerHTML = `<strong>Selected:</strong> ${selectedCustomer.name} - ${selectedCustomer.phone}`;
                    infoDiv.style.display = 'block';
                }
            }
    
            hideSuggestions();
        }

        function hideSuggestions() {
            document.getElementById('customerSuggestions').style.display = 'none';
            currentSuggestionIndex = -1;
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            const input = document.getElementById('customerInput');
            const suggestions = document.getElementById('customerSuggestions');
    
            if (input && suggestions && !input.contains(event.target) && !suggestions.contains(event.target)) {
            hideSuggestions();
            }
        });

        // Finance Management Functions
        function initializeFinance() {
            const savedExpenses = localStorage.getItem('familyCakeExpenses');
            const savedIncome = localStorage.getItem('familyCakeOtherIncome');
            const savedRegister = localStorage.getItem('familyCakeCashRegister');
            const savedCredits = localStorage.getItem('familyCakeCredits');
            const savedWaste = localStorage.getItem('familyCakeWaste');
    
            if (savedExpenses) expenses = JSON.parse(savedExpenses);
            if (savedIncome) otherIncome = JSON.parse(savedIncome);
            if (savedRegister) {
                const saved = JSON.parse(savedRegister);
                if (saved.date === new Date().toDateString()) {
                    cashRegister = saved;
                }
            }
            if (savedCredits) customerCredits = JSON.parse(savedCredits);
            if (savedWaste) wasteRecords = JSON.parse(savedWaste);
        }
        
        function initializeUsers() {
            const savedUsers = localStorage.getItem('familyCakeUsers');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
        }

        function saveFinanceData() {
            localStorage.setItem('familyCakeExpenses', JSON.stringify(expenses));
            localStorage.setItem('familyCakeOtherIncome', JSON.stringify(otherIncome));
            localStorage.setItem('familyCakeCashRegister', JSON.stringify(cashRegister));
            localStorage.setItem('familyCakeCredits', JSON.stringify(customerCredits));
            localStorage.setItem('familyCakeWaste', JSON.stringify(wasteRecords));
        }

        function showFinanceSection(section) {
            // Hide all sections
            document.querySelectorAll('.finance-section').forEach(sec => {
                sec.style.display = 'none';
            });
    
            // Reset button styles
            document.querySelectorAll('#finance .btn').forEach(btn => {
                if (btn.id.includes('Btn')) {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            });
    
            // Show selected section
            const sectionId = section.split('-').map((word, index) => 
                index === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1)
            ).join('') + 'Section';
            document.getElementById(sectionId).style.display = 'block';
            
            // Convert section name to proper camelCase for button ID
            const btnId = section.split('-').map((word, index) => 
                index === 0 ? word : word.charAt(0).toUpperCase() + word.slice(1)
            ).join('') + 'Btn';

            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            }
    
            // Load section-specific data
            if (section === 'cash-register') {
                updateCashRegisterDisplay();
            } else if (section === 'expenses') {
                displayRecentExpenses();
            } else if (section === 'credit') {
                loadCreditCustomers();
                displayCreditSummary();
            } else if (section === 'waste') {
                loadWasteProducts();
                displayWasteRecords();
            }
        }

        function setOpeningBalance() {
            const opening = parseFloat(document.getElementById('openingBalance').value) || 0;
            cashRegister.opening = opening;
            cashRegister.date = new Date().toDateString();
            saveFinanceData();
            updateCashRegisterDisplay();
            alert('Opening balance set successfully!');
        }

        function updateCashRegisterDisplay() {
            // Calculate today's sales from stock movements
            const todaySales = stockMovements
                .filter(m => m.type === 'sale' && new Date(m.timestamp).toDateString() === new Date().toDateString())
                .reduce((sum, m) => sum + (m.revenue || 0), 0);
    
            // Calculate today's expenses
            const todayExpenses = expenses
                .filter(e => new Date(e.date).toDateString() === new Date().toDateString())
                .reduce((sum, e) => sum + e.amount, 0);
    
            cashRegister.sales = todaySales;
            cashRegister.expenses = todayExpenses;
    
            const expected = cashRegister.opening + todaySales - todayExpenses;
    
            document.getElementById('displayOpening').textContent = formatCurrency(cashRegister.opening);
            document.getElementById('displaySales').textContent = formatCurrency(todaySales);
            document.getElementById('displayExpenses').textContent = formatCurrency(todayExpenses);
            document.getElementById('expectedCash').textContent = formatCurrency(expected);
    
            if (cashRegister.closing > 0) {
                const difference = cashRegister.closing - expected;
                document.getElementById('cashDifference').textContent = formatCurrency(difference);
                document.getElementById('cashDifference').style.color = difference >= 0 ? '#28a745' : '#dc3545';
            }
        }

        function closeRegister() {
            const closing = parseFloat(document.getElementById('closingBalance').value) || 0;
            const expected = cashRegister.opening + cashRegister.sales - cashRegister.expenses;
    
            cashRegister.closing = closing;
            cashRegister.difference = closing - expected;
    
            saveFinanceData();
            updateCashRegisterDisplay();
    
            if (cashRegister.difference === 0) {
                alert('Register balanced perfectly!');
            } else if (cashRegister.difference > 0) {
                alert(`Register closed with surplus of ${formatCurrency(cashRegister.difference)}`);
            } else {
                alert(`Register closed with shortage of ${formatCurrency(Math.abs(cashRegister.difference))}`);
            }
        }

        function recordExpense() {
            const category = document.getElementById('expenseCategory').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const payment = document.getElementById('expensePayment').value;
            const remarks = document.getElementById('expenseRemarks').value;
    
            if (amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
    
            const expense = {
                id: Date.now(),
                date: new Date().toISOString(),
                category: category,
                amount: amount,
                paymentMethod: payment,
                remarks: remarks
            };
    
            expenses.push(expense);
            saveFinanceData();
    
            // Clear form
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseRemarks').value = '';
    
            displayRecentExpenses();
            updateCashRegisterDisplay();
            alert('Expense recorded successfully!');
        }

        function displayRecentExpenses() {
            const recentExpenses = expenses.slice(-10).reverse();
            const container = document.getElementById('recentExpenses');
    
            if (recentExpenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No expenses recorded yet</p>';
                return;
            }
    
            const categoryNames = {
                'utilities': 'Utilities',
                'salary': 'Staff Salary',
                'transport': 'Delivery/Transport',
                'packaging': 'Packaging Materials',
                'maintenance': 'Equipment Maintenance',
                'miscellaneous': 'အထွေထွေစရိတ်'
            };
    
            container.innerHTML = recentExpenses.map(expense => `
                <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${categoryNames[expense.category]}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${new Date(expense.date).toLocaleString()}
                            </div>
                            ${expense.remarks ? `<div style="font-size: 13px; margin-top: 5px;"><em>${expense.remarks}</em></div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #dc3545;">${formatCurrency(expense.amount)}</div>
                            <div style="font-size: 12px; color: #666;">${expense.paymentMethod}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function recordIncome() {
            const type = document.getElementById('incomeType').value.trim();
            const amount = parseFloat(document.getElementById('incomeAmount').value) || 0;
            const payment = document.getElementById('incomePayment').value;
            const notes = document.getElementById('incomeNotes').value;
    
            if (!type || amount <= 0) {
                alert('Please enter income type and valid amount');
                return;
            }
    
            otherIncome.push({
                id: Date.now(),
                date: new Date().toISOString(),
                type: type,
                amount: amount,
                paymentMethod: payment,
                notes: notes
            });
    
            saveFinanceData();
    
            // Clear form
            document.getElementById('incomeType').value = '';
            document.getElementById('incomeAmount').value = '';
            document.getElementById('incomeNotes').value = '';
    
            alert('Income recorded successfully!');
        }

        function loadCreditCustomers() {
            const selects = ['creditCustomer', 'paymentCustomer'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Customer</option>' +
                        customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            });
        }

        function addCredit() {
            const customerId = parseInt(document.getElementById('creditCustomer').value);
            const amount = parseFloat(document.getElementById('creditAmount').value) || 0;
            const notes = document.getElementById('creditNotes').value;
    
            if (!customerId || amount <= 0) {
                alert('Please select customer and enter valid amount');
                return;
            }
    
            const customer = customers.find(c => c.id === customerId);
    
            customerCredits.push({
                id: Date.now(),
                date: new Date().toISOString(),
                customerId: customerId,
                customerName: customer.name,
                amount: amount,
                paid: 0,
                notes: notes,
                status: 'pending'
            });
    
            saveFinanceData();
            displayCreditSummary();
    
            // Clear form
            document.getElementById('creditAmount').value = '';
            document.getElementById('creditNotes').value = '';
    
            alert('Credit sale recorded!');
        }

        function updateCreditBalance() {
            const customerId = parseInt(document.getElementById('paymentCustomer').value);
            if (!customerId) {
                document.getElementById('outstandingAmount').textContent = '0 MMK';
                return;
            }
    
            const outstanding = customerCredits
                .filter(c => c.customerId === customerId && c.status === 'pending')
                .reduce((sum, c) => sum + (c.amount - c.paid), 0);
    
            document.getElementById('outstandingAmount').textContent = formatCurrency(outstanding);
        }

        function recordCreditPayment() {
            const customerId = parseInt(document.getElementById('paymentCustomer').value);
            const payment = parseFloat(document.getElementById('paymentAmount').value) || 0;
    
            if (!customerId || payment <= 0) {
                alert('Please select customer and enter valid payment');
                return;
            }
    
            let remainingPayment = payment;
            const credits = customerCredits
                .filter(c => c.customerId === customerId && c.status === 'pending')
                .sort((a, b) => new Date(a.date) - new Date(b.date));
    
            for (let credit of credits) {
                if (remainingPayment <= 0) break;
        
                const outstanding = credit.amount - credit.paid;
                const paymentForThis = Math.min(remainingPayment, outstanding);
        
                credit.paid += paymentForThis;
                remainingPayment -= paymentForThis;
        
                if (credit.paid >= credit.amount) {
                    credit.status = 'paid';
                }
            }
    
            saveFinanceData();
            updateCreditBalance();
            displayCreditSummary();
    
            document.getElementById('paymentAmount').value = '';
            alert(`Payment of ${formatCurrency(payment)} recorded!`);
        }

        function displayCreditSummary() {
            const container = document.getElementById('creditSummary');
            const pendingCredits = customerCredits.filter(c => c.status === 'pending');
    
            if (pendingCredits.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No outstanding credits</p>';
                return;
            }
    
            const summary = {};
            pendingCredits.forEach(credit => {
                if (!summary[credit.customerId]) {
                    summary[credit.customerId] = {
                        name: credit.customerName,
                        total: 0
                    };
                }
                summary[credit.customerId].total += (credit.amount - credit.paid);
            });
    
            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    ${Object.values(summary).map(s => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #dee2e6;">
                            <span>${s.name}</span>
                            <span style="font-weight: bold; color: #dc3545;">${formatCurrency(s.total)}</span>
                        </div>
                    `).join('')}
                    <div style="display: flex; justify-content: space-between; padding-top: 10px; font-weight: bold;">
                        <span>Total Outstanding</span>
                        <span style="color: #dc3545;">${formatCurrency(pendingCredits.reduce((sum, c) => sum + (c.amount - c.paid), 0))}</span>
                    </div>
                </div>
            `;
        }

        function loadWasteProducts() {
            const select = document.getElementById('wasteProduct');
            if (select) {
                select.innerHTML = '<option value="">Select Product</option>' +
                    products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }
        }

        function updateWasteVariants() {
            const productId = parseInt(document.getElementById('wasteProduct').value);
            const variantSelect = document.getElementById('wasteVariant');
    
            if (!productId) {
                variantSelect.innerHTML = '<option value="">Select Variant</option>';
                return;
            }
    
            const product = products.find(p => p.id === productId);
            variantSelect.innerHTML = '<option value="">Select Variant</option>' +
                product.variants.map(v => `<option value="${v.id}">${v.name} (Stock: ${v.stock})</option>`).join('');
        }

        function recordWaste() {
            const productId = parseInt(document.getElementById('wasteProduct').value);
            const variantId = document.getElementById('wasteVariant').value;
            const quantity = parseInt(document.getElementById('wasteQuantity').value) || 0;
            const remarks = document.getElementById('wasteRemarks').value.trim();
    
            if (!productId || !variantId || quantity <= 0 || !remarks) {
                alert('Please fill all fields including reason for disposal');
                return;
            }
    
            const product = products.find(p => p.id === productId);
            const variant = product?.variants.find(v => v.id === variantId);
    
            if (!variant) {
                alert('Invalid product or variant');
                return;
            }
    
            if (quantity > variant.stock) {
                alert(`Only ${variant.stock} items available in stock`);
                return;
            }
    
            // Calculate waste value
            const wasteValue = variant.costPrice * quantity;
    
            // Record waste
            wasteRecords.push({
                id: Date.now(),
                date: new Date().toISOString(),
                productId: productId,
                productName: product.name,
                variantId: variantId,
                variantName: variant.name,
                quantity: quantity,
                costPrice: variant.costPrice,
                totalValue: wasteValue,
                reason: remarks
            });
    
            // Reduce stock
            variant.stock -= quantity;
    
            // Log stock movement
            logStockMovement(productId, variantId, 'waste', quantity, variant.stock, `Waste: ${remarks}`, variant.costPrice, 0);
    
        saveProducts();
        saveFinanceData();
    
            // Clear form
            document.getElementById('wasteQuantity').value = '';
            document.getElementById('wasteRemarks').value = '';
    
            displayWasteRecords();
            updateProductGrid();
    
            alert(`Waste recorded! Loss value: ${formatCurrency(wasteValue)}`);
        }

        function displayWasteRecords() {
            const container = document.getElementById('wasteRecords');
            if (!container) return;
    
            const recentWaste = wasteRecords.slice(-10).reverse();
    
            if (recentWaste.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No waste records</p>';
                return;
            }
    
            container.innerHTML = recentWaste.map(waste => `
                <div style="background: #ffe6e6; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <strong>${waste.productName} - ${waste.variantName}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                ${new Date(waste.date).toLocaleString()} | Qty: ${waste.quantity}
                            </div>
                            <div style="font-size: 13px; margin-top: 5px;">
                                <em>Reason: ${waste.reason}</em>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #dc3545;">
                                Loss: ${formatCurrency(waste.totalValue)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateSuppliersList() {
            const suppliersList = document.getElementById('suppliersList');
            
            if (suppliers.length === 0) {
                suppliersList.innerHTML = '<p style="text-align: center; color: #666;">No suppliers added yet</p>';
                return;
            }
            
            suppliersList.innerHTML = suppliers.map(supplier => {
                // Count products from this supplier
                const productCount = products.filter(p => 
                    (p.supplierIds || []).includes(supplier.id) || 
                    (p.supplierId === supplier.id)
                ).length;

                return `
                <div class="supplier-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h3>${supplier.name}</h3>
                            <div style="display: grid; gap: 5px; margin-top: 10px;">
                                <p style="margin: 0;"><strong>Contact:</strong> ${supplier.contact}</p>
                                <p style="margin: 0;"><strong>Email:</strong> ${supplier.email}</p>
                                <p style="margin: 0;"><strong>Address:</strong> ${supplier.address}</p>
                                <p style="margin: 0;"><strong>Payment Terms:</strong> ${supplier.paymentTerms}</p>
                                <p style="margin: 0;"><strong>Products:</strong> ${productCount}</p>
                                <p style="margin: 0; color: ${supplier.outstandingBalance > 0 ? '#dc3545' : '#28a745'};">
                                    <strong>Outstanding Balance:</strong> ${formatCurrency(supplier.outstandingBalance)}
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-info btn-sm" onclick="showManageProductsModal(${supplier.id})">Manage Products</button>
                            <button class="btn btn-primary btn-sm" onclick="editSupplier(${supplier.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSupplier(${supplier.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function showManageProductsModal(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;

            const assignedProducts = products.filter(p => 
                (p.supplierIds || []).includes(supplierId) || 
                (p.supplierId === supplierId)
            );

            const modalHtml = `
                <div id="manageProductsModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 700px;">
                        <span class="close" onclick="closeModal('manageProductsModal')">&times;</span>
                        <h3>Manage Products for ${supplier.name}</h3>
                        <div style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
                            ${products.map(product => {
                                const isAssigned = (product.supplierIds || []).includes(supplierId) || 
                                         (product.supplierId === supplierId);
                                const hasPendingPO = purchaseOrders.some(po => 
                                    po.supplierId === supplierId && 
                                    po.status === 'pending' && 
                                    po.items.some(item => item.productId === product.id)
                                );         

                                return `
                                    <div style="padding: 10px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center;">
                                        <input type="checkbox" 
                                                id="product-check-${product.id}" 
                                                value="${product.id}" 
                                                ${isAssigned ? 'checked' : ''}
                                                ${isAssigned && hasPendingPO ? 'disabled' : ''}
                                                style="margin-right: 15px; transform: scale(1.5);">
                                        <label for="product-check-${product.id}" style="flex: 1; cursor: pointer;">
                                            <strong>${product.name}</strong>
                                            <div style="font-size: 12px; color: #666;">
                                                ${product.category} | ${product.variants.length} variants
                                                ${isAssigned && hasPendingPO ? '<span style="color: #dc3545;"> (Has pending PO - cannot unassign)</span>' : ''}
                                            </div>
                                        </label>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-secondary" onclick="closeModal('manageProductsModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="saveSupplierProducts(${supplierId})">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;

            const existingModal = document.getElementById('manageProductsModal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function saveSupplierProducts(supplierId) {
            const checkboxes = document.querySelectorAll('#manageProductsModal input[type="checkbox"]:not(:disabled)');

            checkboxes.forEach(checkbox => {
                const productId = parseInt(checkbox.value);
                const product = products.find(p => p.id === productId);
                if (!product) return;
        
                if (!product.supplierIds) {
                    product.supplierIds = product.supplierId ? [product.supplierId] : [];
                }
        
                if (checkbox.checked) {
                    if (!product.supplierIds.includes(supplierId)) {
                        product.supplierIds.push(supplierId);
                    }
                } else {
                    product.supplierIds = product.supplierIds.filter(id => id !== supplierId);
                }   
        
                // Clean up old supplierId field
                delete product.supplierId;
            });
    
            saveProducts();
            updateSuppliersList();
            closeModal('manageProductsModal');
            alert('Supplier products updated successfully!');
        }
        function editSupplier(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            
            editingSupplierId = supplierId;
            showAddSupplierModal();
            
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierContact').value = supplier.contact;
            document.getElementById('supplierEmail').value = supplier.email;
            document.getElementById('supplierAddress').value = supplier.address;
            document.getElementById('supplierPaymentTerms').value = supplier.paymentTerms;
        }

        function deleteSupplier(supplierId) {
            const hasProducts = products.some(p => p.supplierId === supplierId);
            if (hasProducts) {
                alert('Cannot delete supplier with associated products. Please reassign products first.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this supplier?')) return;
            
            suppliers = suppliers.filter(s => s.id !== supplierId);
            saveProducts();
            updateSuppliersList();
        }

        // Purchase Order Functions
        function showCreatePOModal() {
            const modalHtml = `
                <div id="poModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 800px;">
                        <span class="close" onclick="closeModal('poModal')">&times;</span>
                        <h3>Create Purchase Order</h3>
                        <div class="form-group">
                            <label class="form-label">Select Supplier</label>
                            <select class="form-select" id="poSupplier" onchange="updatePOProducts()">
                                <option value="">Select a supplier...</option>
                                ${suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="poProductsList"></div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                            <h4>Order Total: <span id="poTotal" style="color: #e91e63;">0 MMK</span></h4>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('poModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="createPurchaseOrder()">Create Order</button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('poModal');
            if (existingModal) existingModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function showDatePickerModal() {
            const modalHtml = `
                <div id="datePickerModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 500px;">
                        <span class="close" onclick="closeModal('datePickerModal')">&times;</span>
                        <h3 style="text-align: center; margin-bottom: 20px;">Select Date Range</h3>
                
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <button class="btn btn-secondary btn-sm" onclick="changeCalendarMonth(-1)">◀</button>
                                <h4 id="calendarMonthYear" style="margin: 0;">${currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h4>
                                <button class="btn btn-secondary btn-sm" onclick="changeCalendarMonth(1)">▶</button>
                            </div>
                    
                            <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                                <!-- Calendar will be generated here -->
                            </div>
                        </div>
                
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                            <div>
                                <label style="font-weight: 600;">Start Date</label>
                                <input type="text" id="startDateInput" class="form-input" readonly style="background: #f8f9fa;" />
                            </div>
                            <div>
                                <label style="font-weight: 600;">End Date</label>
                                <input type="text" id="endDateInput" class="form-input" readonly style="background: #f8f9fa;" />
                            </div>
                        </div>
                
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary btn-sm" onclick="setQuickDateRange('today')">Today</button>
                            <button class="btn btn-secondary btn-sm" onclick="setQuickDateRange('yesterday')">Yesterday</button>
                            <button class="btn btn-secondary btn-sm" onclick="setQuickDateRange('week')">This Week</button>
                            <button class="btn btn-secondary btn-sm" onclick="setQuickDateRange('month')">This Month</button>
                        </div>
                
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('datePickerModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="applyDateRange()">Apply</button>
                        </div>
                    </div>
                </div>
            `;
    
            const existingModal = document.getElementById('datePickerModal');
            if (existingModal) existingModal.remove();
    
            document.body.insertAdjacentHTML('beforeend', modalHtml);
    
            generateCalendar();
            updateDateInputs();
        }

        function generateCalendar() {
            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
    
            const calendarGrid = document.getElementById('calendarGrid');
            if (!calendarGrid) return;
    
            let html = '';
    
            // Day headers
            const dayHeaders = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            dayHeaders.forEach(day => {
                html += `<div style="text-align: center; font-weight: bold; padding: 5px;">${day}</div>`;
            });
    
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }
    
            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isSelected = isDateInRange(date);
                const isToday = isDateToday(date);
        
                html += `
                    <div onclick="selectDate(${year}, ${month}, ${day})"
                        style="text-align: center; padding: 10px; cursor: pointer; border-radius: 5px;
                                background: ${isSelected ? '#e91e63' : isToday ? '#fce4ec' : '#fff'};
                                color: ${isSelected ? 'white' : 'black'};">
                        ${day}
                    </div>
                `;
            }
    
            calendarGrid.innerHTML = html;
        }

        function changeCalendarMonth(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            document.getElementById('calendarMonthYear').textContent = 
                currentCalendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            generateCalendar();
        }

        function selectDate(year, month, day) {
            const selectedDate = new Date(year, month, day);
    
            if (!reportStartDate || (reportStartDate && reportEndDate)) {
                // Starting new selection
                reportStartDate = selectedDate;
                reportEndDate = null;
            } else {
                // Completing selection
                if (selectedDate < reportStartDate) {
                    reportEndDate = reportStartDate;
                    reportStartDate = selectedDate;
                } else {
                    reportEndDate = selectedDate;
                }
            }
    
            generateCalendar();
            updateDateInputs();
        }

        function showExportOptionsModal() {
            const modalHtml = `
                <div id="exportModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('exportModal')">&times;</span>
                        <h3>What do you want to export?</h3>
                        <div style="display: grid; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="exportSalesSummary()">Sales Summary</button>
                            <button class="btn btn-primary" onclick="exportSalesByItem()">Sales by Item</button>
                            <button class="btn btn-primary" onclick="exportSalesByCategory()">Sales by Category</button>
                            <button class="btn btn-primary" onclick="exportSalesByCustomer()">Sales by Customer</button>
                            <button class="btn btn-primary" onclick="exportExpensesLog()">Expenses Log</button>
                            <button class="btn btn-primary" onclick="exportStockMovementLog()">Stock Movement Log</button>
                            <button class="btn btn-secondary" onclick="closeModal('exportModal')">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
    
            const existingModal = document.getElementById('exportModal');
            if (existingModal) existingModal.remove();
    
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function exportSalesSummary() {
            const filteredMovements = getFilteredSalesMovements();
    
            let csv = 'Sales Summary Report\n';
            csv += `Period: ${reportStartDate.toLocaleDateString()} - ${reportEndDate.toLocaleDateString()}\n\n`;
            csv += 'Date,Total Sales,Total Profit,Number of Transactions\n';
    
            // Group by date
            const salesByDate = {};
            filteredMovements.forEach(m => {
                const date = new Date(m.timestamp).toLocaleDateString();
                if (!salesByDate[date]) {
                    salesByDate[date] = { revenue: 0, profit: 0, count: 0 };
                }
                salesByDate[date].revenue += m.revenue || 0;
                salesByDate[date].profit += m.profit || 0;
                salesByDate[date].count++;
            });
    
            Object.entries(salesByDate).forEach(([date, stats]) => {
                csv += `${date},${stats.revenue},${stats.profit},${stats.count}\n`;
            });
    
            downloadCSV(csv, 'sales-summary.csv');
            closeModal('exportModal');
        }

        function exportSalesByItem() {
            const filteredMovements = getFilteredSalesMovements();
    
            let csv = 'Sales by Item Report\n';
            csv += `Period: ${reportStartDate.toLocaleDateString()} - ${reportEndDate.toLocaleDateString()}\n\n`;
            csv += 'Product,Variant,Quantity Sold,Revenue,Cost,Profit,Profit Margin\n';
    
            // Group by product-variant
            const itemSales = {};
            filteredMovements.forEach(m => {
                const key = `${m.productName}|${m.variantName}`;
                if (!itemSales[key]) {
                    itemSales[key] = {
                        product: m.productName,
                        variant: m.variantName,
                        quantity: 0,
                        revenue: 0,
                        cost: 0,
                        profit: 0
                    };
                }
                itemSales[key].quantity += m.quantity;
                itemSales[key].revenue += m.revenue || 0;
                itemSales[key].cost += (m.cost * m.quantity) || 0;
                itemSales[key].profit += m.profit || 0;
            });
    
            Object.values(itemSales).forEach(item => {
                const margin = item.revenue ? ((item.profit / item.revenue) * 100).toFixed(1) : 0;
                csv += `${item.product},${item.variant},${item.quantity},${item.revenue},${item.cost},${item.profit},${margin}%\n`;
            });
    
            downloadCSV(csv, 'sales-by-item.csv');
            closeModal('exportModal');
        }

        function exportSalesByCategory() {
            const filteredMovements = getFilteredSalesMovements();
    
            let csv = 'Sales by Category Report\n';
            csv += `Period: ${reportStartDate.toLocaleDateString()} - ${reportEndDate.toLocaleDateString()}\n\n`;
            csv += 'Category,Items Sold,Revenue,Profit\n';
    
            // Group by category
            const categorySales = {};
            filteredMovements.forEach(m => {
                const product = products.find(p => p.id === m.productId);
                const category = product ? product.category : 'unknown';
        
                if (!categorySales[category]) {
                    categorySales[category] = { quantity: 0, revenue: 0, profit: 0 };
                }
                categorySales[category].quantity += m.quantity;
                categorySales[category].revenue += m.revenue || 0;
                categorySales[category].profit += m.profit || 0;
            });
    
            Object.entries(categorySales).forEach(([category, stats]) => {
                csv += `${category},${stats.quantity},${stats.revenue},${stats.profit}\n`;
            });
    
            downloadCSV(csv, 'sales-by-category.csv');
            closeModal('exportModal');
        }

        function exportSalesByCustomer() {
            // This would need to be implemented when you add customer tracking to sales
            alert('Customer tracking in sales needs to be implemented first');
            closeModal('exportModal');
        }

        function exportExpensesLog() {
            let csv = 'Expenses Log Report\n';
            csv += `Period: ${reportStartDate.toLocaleDateString()} - ${reportEndDate.toLocaleDateString()}\n\n`;
            csv += 'Date,Category,Amount,Payment Method,Remarks\n';
    
            const filteredExpenses = expenses.filter(e => {
                const expDate = new Date(e.date);
                return expDate >= reportStartDate && expDate <= reportEndDate;
            });
    
            filteredExpenses.forEach(expense => {
                const date = new Date(expense.date).toLocaleDateString();
                csv += `${date},${expense.category},${expense.amount},${expense.paymentMethod},"${expense.remarks || ''}"\n`;
            });
    
            downloadCSV(csv, 'expenses-log.csv');
            closeModal('exportModal');
        }

        function exportStockMovementLog() {
            const filteredMovements = stockMovements.filter(m => {
                const moveDate = new Date(m.timestamp);
                return moveDate >= reportStartDate && moveDate <= reportEndDate;
            });
    
            let csv = 'Stock Movement Log\n';
            csv += `Period: ${reportStartDate.toLocaleDateString()} - ${reportEndDate.toLocaleDateString()}\n\n`;
            csv += 'Date,Time,Product,Variant,Type,Quantity,Cost,Revenue,Profit,New Stock,Reason\n';
    
            filteredMovements.forEach(m => {
                const date = new Date(m.timestamp);
                csv += `${date.toLocaleDateString()},${date.toLocaleTimeString()},${m.productName},${m.variantName},${m.type},${m.quantity},${m.cost * m.quantity},${m.revenue || 0},${m.profit || 0},${m.newStock},"${m.reason || ''}"\n`;
            });
    
            downloadCSV(csv, 'stock-movement-log.csv');
            closeModal('exportModal');
        }

        function getFilteredSalesMovements() {
            return stockMovements.filter(m => {
                const moveDate = new Date(m.timestamp);
                return moveDate >= reportStartDate && moveDate <= reportEndDate && m.type === 'sale';
            });
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function updateDateInputs() {
            if (reportStartDate) {
                document.getElementById('startDateInput').value = reportStartDate.toLocaleDateString();
            }
            if (reportEndDate) {
                document.getElementById('endDateInput').value = reportEndDate.toLocaleDateString();
            }
        }

        function setQuickDateRange(range) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
    
            switch(range) {
                case 'today':
                    reportStartDate = new Date(today);
                    reportEndDate = new Date(today);
                    break;
                case 'yesterday':
                    reportStartDate = new Date(today.setDate(today.getDate() - 1));
                    reportEndDate = new Date(reportStartDate);
                    break;
                case 'week':
                    reportStartDate = new Date(today.setDate(today.getDate() - today.getDay()));
                    reportEndDate = new Date();
                break;
                case 'month':
                    reportStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    reportEndDate = new Date();
                break;
            }
    
            generateCalendar();
            updateDateInputs();
        }

        function isDateInRange(date) {
            if (!reportStartDate) return false;
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const startOnly = new Date(reportStartDate.getFullYear(), reportStartDate.getMonth(), reportStartDate.getDate());
            const endOnly = reportEndDate ? new Date(reportEndDate.getFullYear(), reportEndDate.getMonth(), reportEndDate.getDate()) : startOnly;
    
            return dateOnly >= startOnly && dateOnly <= endOnly;
        }

        function isDateToday(date) {
            const today = new Date();
            return date.getFullYear() === today.getFullYear() &&
                date.getMonth() === today.getMonth() &&
                date.getDate() === today.getDate();
        }

        function applyDateRange() {
            if (!reportStartDate || !reportEndDate) {
                alert('Please select both start and end dates');
                return;
            }
    
            updateReportView(reportStartDate, reportEndDate);
            closeModal('datePickerModal');
        }

        function updatePOProducts() {
            const supplierId = parseInt(document.getElementById('poSupplier').value);
            const supplierProducts = products.filter(p => 
                (p.supplierIds || []).includes(supplierId) || 
                (p.supplierId === supplierId)
            );
            
            const poProductsList = document.getElementById('poProductsList');
            
            if (supplierProducts.length === 0) {
                poProductsList.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">No products assigned to this supplier</p>';
                return;
            }
            
            poProductsList.innerHTML = `
                <h4 style="margin-top: 20px;">Select Products and Quantities:</h4>
                ${supplierProducts.map(product => `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h5>${product.name}</h5>
                        <div style="display: grid; gap: 10px;">
                            ${product.variants.map(variant => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 5px;">
                                    <div>
                                        <strong>${variant.name}</strong>
                                        <span style="margin-left: 10px; color: #666;">Current Stock: ${variant.stock}</span>
                                        <span style="margin-left: 10px; color: #e91e63;">Cost: ${formatCurrency(variant.costPrice)}</span>
                                    </div>
                                    <input type="number" 
                                           class="form-input po-qty-input" 
                                           id="po-qty-${variant.id}" 
                                           data-cost="${variant.costPrice}"
                                           data-product-id="${product.id}"
                                           data-variant-id="${variant.id}"
                                           onchange="updatePOTotal()"
                                           placeholder="Qty" 
                                           min="0" 
                                           style="width: 100px;">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function updatePOTotal() {
            let total = 0;
            document.querySelectorAll('.po-qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                const cost = parseInt(input.dataset.cost) || 0;
                total += qty * cost;
            });
            document.getElementById('poTotal').textContent = formatCurrency(total);
        }

        function createPurchaseOrder() {
            const supplierId = parseInt(document.getElementById('poSupplier').value);
            if (!supplierId) {
                alert('Please select a supplier');
                return;
            }
            
            const supplier = suppliers.find(s => s.id === supplierId);
            const items = [];
            let total = 0;
            
            document.querySelectorAll('.po-qty-input').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    const productId = parseInt(input.dataset.productId);
                    const variantId = input.dataset.variantId;
                    const cost = parseInt(input.dataset.cost);
                    
                    const product = products.find(p => p.id === productId);
                    const variant = product?.variants.find(v => v.id === variantId);
                    
                    if (product && variant) {
                        items.push({
                            productId: productId,
                            productName: product.name,
                            variantId: variantId,
                            variantName: variant.name,
                            quantity: qty,
                            costPrice: cost,
                            totalCost: cost * qty
                        });
                        total += cost * qty;
                    }
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item to the order');
                return;
            }
            
            const po = {
                id: Date.now(),
                supplierId: supplierId,
                supplierName: supplier.name,
                items: items,
                totalAmount: total,
                status: 'pending',
                createdDate: new Date().toISOString(),
                receivedDate: null
            };
            
            purchaseOrders.push(po);
            supplier.outstandingBalance += total;
            
            saveProducts();
            updatePurchaseOrdersList();
            closeModal('poModal');
            alert('Purchase order created successfully!');
        }

        function updatePurchaseOrdersList() {
            const poList = document.getElementById('purchaseOrdersList');
            
            if (purchaseOrders.length === 0) {
                poList.innerHTML = '<p style="text-align: center; color: #666;">No purchase orders yet</p>';
                return;
            }
            
            poList.innerHTML = purchaseOrders.map(po => {
                const date = new Date(po.createdDate);
                const supplier = suppliers.find(s => s.id === po.supplierId);
                
                return `
                <div class="po-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4>PO #${po.id}</h4>
                            <div style="display: grid; gap: 5px; margin-top: 10px;">
                                <p style="margin: 0;"><strong>Supplier:</strong> ${po.supplierName}</p>
                                <p style="margin: 0;"><strong>Date:</strong> ${date.toLocaleDateString()}</p>
                                <p style="margin: 0;"><strong>Items:</strong> ${po.items.length}</p>
                                <p style="margin: 0;"><strong>Total:</strong> ${formatCurrency(po.totalAmount)}</p>
                                <p style="margin: 0;">
                                    <span class="po-status ${po.status}">${po.status.toUpperCase()}</span>
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${po.status === 'pending' ? 
                                `<button class="btn btn-success btn-sm" onclick="receivePurchaseOrder(${po.id})">Receive</button>` : 
                                `<span style="color: #28a745;">✓ Received</span>`
                            }
                            <button class="btn btn-info btn-sm" onclick="viewPODetails(${po.id})">View</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function updateReportView(startDate, endDate) {
            // Update display
            const display = document.getElementById('dateRangeDisplay');
            if (startDate.toDateString() === endDate.toDateString()) {
                if (startDate.toDateString() === new Date().toDateString()) {
                    display.textContent = 'Showing data for: Today';
                } else {
                    display.textContent = `Showing data for: ${startDate.toLocaleDateString()}`;
                }
            } else {
                display.textContent = `Showing data for: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            }

        // Update all report components with filtered data
            updateFilteredStatsGrid(startDate, endDate);
            updateFilteredProfitAnalysis(startDate, endDate);
            updateStockLogDisplay(startDate, endDate); // This now filters the log
        }

        function updateFilteredStatsGrid(startDate, endDate) {
            const statsGrid = document.getElementById('statsGrid');
    
            // Filter stock movements by date
            const filteredMovements = stockMovements.filter(m => {
                const moveDate = new Date(m.timestamp);
                moveDate.setHours(0, 0, 0, 0);
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                return moveDate >= start && moveDate <= end;
            });
    
            // Calculate filtered statistics
            const totalProducts = products.length;
            const totalStockValue = products.reduce((sum, p) => {
                return sum + p.variants.reduce((vSum, v) => vSum + (v.stock * v.costPrice), 0);
            }, 0);
    
            const totalSales = filteredMovements.filter(m => m.type === 'sale').reduce((sum, m) => sum + (m.revenue || 0), 0);
            const totalProfit = filteredMovements.filter(m => m.type === 'sale').reduce((sum, m) => sum + (m.profit || 0), 0);
    
            const lowStockItems = products.reduce((count, p) => {
                return count + p.variants.filter(v => v.stock > 0 && v.stock <= p.lowStockThreshold).length;
            }, 0);
    
            const outOfStockItems = products.reduce((count, p) => {
                return count + p.variants.filter(v => v.stock === 0).length;
            }, 0);
    
            const pendingPOs = purchaseOrders.filter(po => po.status === 'pending').length;
            const totalOutstanding = suppliers.reduce((sum, s) => sum + s.outstandingBalance, 0);
    
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalProducts}</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalStockValue)}</div>
                    <div class="stat-label">Stock Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalSales)}</div>
                    <div class="stat-label">Sales (Period)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #28a745;">${formatCurrency(totalProfit)}</div>
                    <div class="stat-label">Profit (Period)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ffc107;">${lowStockItems}</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #dc3545;">${outOfStockItems}</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${pendingPOs}</div>
                    <div class="stat-label">Pending POs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #dc3545;">${formatCurrency(totalOutstanding)}</div>
                    <div class="stat-label">Outstanding Balance</div>
                </div>
            `;
        }

        function updateFilteredProfitAnalysis(startDate, endDate) {
            // Filter movements for the selected period
            const filteredMovements = stockMovements.filter(m => {
                const moveDate = new Date(m.timestamp);
                moveDate.setHours(0, 0, 0, 0);
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                return moveDate >= start && moveDate <= end && m.type === 'sale';
            });
    
            // Top selling products for the period
            const productSales = {};
            filteredMovements.forEach(movement => {
                const key = `${movement.productName} - ${movement.variantName}`;
                if (!productSales[key]) {
                    productSales[key] = {
                        quantity: 0,
                        revenue: 0,
                        profit: 0
                    };
                }
                productSales[key].quantity += movement.quantity;
                productSales[key].revenue += movement.revenue || 0;
                productSales[key].profit += movement.profit || 0;
            });
    
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
    
            const existingReport = document.querySelector('#profitReport');
            if (existingReport) {
                existingReport.innerHTML = `
                    <h4 style="margin-bottom: 15px;">Top Selling Products (Selected Period)</h4>
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                        ${topProducts.length > 0 ? topProducts.map(([name, stats]) => `
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                                <div>
                                    <strong>${name}</strong>
                                    <div style="font-size: 0.9em; color: #666;">Qty: ${stats.quantity}</div>
                                </div>
                            <div style="text-align: right;">
                                <div style="color: #e91e63;">${formatCurrency(stats.revenue)}</div>
                                <div style="color: #28a745; font-size: 0.9em;">Profit: ${formatCurrency(stats.profit)}</div>
                            </div>
                        </div>
                    `).join('') : '<p style="text-align: center; color: #666;">No sales data for selected period</p>'}
                    </div>
                `;
            }
        }

        function receivePurchaseOrder(poId) {
            const po = purchaseOrders.find(p => p.id === poId);
            if (!po || po.status === 'received') return;
            
            if (!confirm('Receive all items in this purchase order?')) return;
            
            // Update stock for all items
            po.items.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                const variant = product?.variants.find(v => v.id === item.variantId);
                
                if (variant) {
                    const oldStock = variant.stock;
                    variant.stock += item.quantity;
                    
                    logStockMovement(
                        item.productId,
                        item.variantId,
                        'purchase',
                        item.quantity,
                        variant.stock,
                        `Purchase Order #${po.id}`,
                        item.costPrice,
                        0
                    );
                }
            });
            
            po.status = 'received';
            po.receivedDate = new Date().toISOString();
            
            const supplier = suppliers.find(s => s.id === po.supplierId);
            if (supplier && supplier.paymentTerms !== 'COD') {
                supplier.outstandingBalance -= po.totalAmount;
            }

            saveProducts();
            updatePurchaseOrdersList();
            updateProductGrid();
            updateInventoryDisplay();
            
            alert('Purchase order received successfully! Stock has been updated.');
        }
        function checkPOProductValidity(po) {
            const invalidItems = po.items.filter(item => {
                const product = products.find(p => p.id === item.productId);
                return product && !(product.supplierIds || []).includes(po.supplierId) && 
                    product.supplierId !== po.supplierId;
    });
    
            if (invalidItems.length > 0) {
                return `<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    ⚠️ Warning: Some products are no longer supplied by ${po.supplierName}
                </div>`;
            }
            return '';
        }
        function viewPODetails(poId) {
            const po = purchaseOrders.find(p => p.id === poId);
            if (!po) return;
            
            const modalHtml = `
                <div id="poDetailsModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('poDetailsModal')">&times;</span>
                        <h3>Purchase Order #${po.id}</h3>
                        <div style="margin: 20px 0;">
                            <p><strong>Supplier:</strong> ${po.supplierName}</p>${checkPOProductValidity(po)}
                            <p><strong>Created:</strong> ${new Date(po.createdDate).toLocaleString()}</p>
                            ${po.receivedDate ? `<p><strong>Received:</strong> ${new Date(po.receivedDate).toLocaleString()}</p>` : ''}
                            <p><strong>Status:</strong> <span class="po-status ${po.status}">${po.status.toUpperCase()}</span></p>
                        </div>
                        <h4>Items:</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left;">Product</th>
                                        <th style="padding: 10px; text-align: left;">Variant</th>
                                        <th style="padding: 10px; text-align: left;">Qty</th>
                                        <th style="padding: 10px; text-align: left;">Cost</th>
                                        <th style="padding: 10px; text-align: left;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${po.items.map(item => `
                                        <tr>
                                            <td style="padding: 10px;">${item.productName}</td>
                                            <td style="padding: 10px;">${item.variantName}</td>
                                            <td style="padding: 10px;">${item.quantity}</td>
                                            <td style="padding: 10px;">${formatCurrency(item.costPrice)}</td>
                                            <td style="padding: 10px;">${formatCurrency(item.totalCost)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f8f9fa; font-weight: bold;">
                                        <td colspan="4" style="padding: 10px; text-align: right;">Total:</td>
                                        <td style="padding: 10px;">${formatCurrency(po.totalAmount)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div style="text-align: right; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="closeModal('poDetailsModal')">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            const existingModal = document.getElementById('poDetailsModal');
            if (existingModal) existingModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
            // Reports and Analytics Functions
        function updateReportsPage() {
            updateStatsGrid();
            updateProfitAnalysis();
        }

        function updateStatsGrid() {
            const statsGrid = document.getElementById('statsGrid');
            
            // Calculate statistics
            const totalProducts = products.length;
            const totalVariants = products.reduce((sum, p) => sum + p.variants.length, 0);
            const totalStockValue = products.reduce((sum, p) => {
                return sum + p.variants.reduce((vSum, v) => vSum + (v.stock * v.costPrice), 0);
            }, 0);
            
            const totalSales = stockMovements.filter(m => m.type === 'sale').reduce((sum, m) => sum + (m.revenue || 0), 0);
            const totalProfit = stockMovements.filter(m => m.type === 'sale').reduce((sum, m) => sum + (m.profit || 0), 0);
            
            const lowStockItems = products.reduce((count, p) => {
                return count + p.variants.filter(v => v.stock > 0 && v.stock <= p.lowStockThreshold).length;
            }, 0);
            
            const outOfStockItems = products.reduce((count, p) => {
                return count + p.variants.filter(v => v.stock === 0).length;
            }, 0);
            
            const pendingPOs = purchaseOrders.filter(po => po.status === 'pending').length;
            const totalOutstanding = suppliers.reduce((sum, s) => sum + s.outstandingBalance, 0);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalProducts}</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalVariants}</div>
                    <div class="stat-label">Total Variants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalStockValue)}</div>
                    <div class="stat-label">Stock Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatCurrency(totalSales)}</div>
                    <div class="stat-label">Total Sales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #28a745;">${formatCurrency(totalProfit)}</div>
                    <div class="stat-label">Total Profit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ffc107;">${lowStockItems}</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #dc3545;">${outOfStockItems}</div>
                    <div class="stat-label">Out of Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${pendingPOs}</div>
                    <div class="stat-label">Pending POs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #dc3545;">${formatCurrency(totalOutstanding)}</div>
                    <div class="stat-label">Outstanding Balance</div>
                </div>
            `;
        }

        function updateProfitAnalysis() {
            // Group sales by date
            const salesByDate = {};
            const today = new Date();
            const last30Days = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            const last7Days = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            stockMovements.filter(m => m.type === 'sale').forEach(movement => {
                const date = new Date(movement.timestamp).toDateString();
                if (!salesByDate[date]) {
                    salesByDate[date] = {
                        revenue: 0,
                        profit: 0,
                        cost: 0,
                        count: 0
                    };
                }
                salesByDate[date].revenue += movement.revenue || 0;
                salesByDate[date].profit += movement.profit || 0;
                salesByDate[date].cost += (movement.cost * movement.quantity) || 0;
                salesByDate[date].count += 1;
            });
            
            // Calculate totals for different periods
            let todayStats = { revenue: 0, profit: 0, count: 0 };
            let weekStats = { revenue: 0, profit: 0, count: 0 };
            let monthStats = { revenue: 0, profit: 0, count: 0 };
            
            Object.entries(salesByDate).forEach(([dateStr, stats]) => {
                const date = new Date(dateStr);
                if (date.toDateString() === today.toDateString()) {
                    todayStats = stats;
                }
                if (date >= last7Days) {
                    weekStats.revenue += stats.revenue;
                    weekStats.profit += stats.profit;
                    weekStats.count += stats.count;
                }
                if (date >= last30Days) {
                    monthStats.revenue += stats.revenue;
                    monthStats.profit += stats.profit;
                    monthStats.count += stats.count;
                }
            });
            
            // Calculate profit margins
            const todayMargin = todayStats.revenue ? ((todayStats.profit / todayStats.revenue) * 100).toFixed(1) : 0;
            const weekMargin = weekStats.revenue ? ((weekStats.profit / weekStats.revenue) * 100).toFixed(1) : 0;
            const monthMargin = monthStats.revenue ? ((monthStats.profit / monthStats.revenue) * 100).toFixed(1) : 0;
            
            // Top selling products
            const productSales = {};
            stockMovements.filter(m => m.type === 'sale').forEach(movement => {
                const key = `${movement.productName} - ${movement.variantName}`;
                if (!productSales[key]) {
                    productSales[key] = {
                        quantity: 0,
                        revenue: 0,
                        profit: 0
                    };
                }
                productSales[key].quantity += movement.quantity;
                productSales[key].revenue += movement.revenue || 0;
                productSales[key].profit += movement.profit || 0;
            });
            
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1].revenue - a[1].revenue)
                .slice(0, 5);
            
            const profitReport = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                        <h5 style="margin-bottom: 10px;">Today</h5>
                        <div style="font-size: 1.2em; font-weight: bold; color: #e91e63;">${formatCurrency(todayStats.revenue)}</div>
                        <div style="color: #28a745;">Profit: ${formatCurrency(todayStats.profit)}</div>
                        <div style="color: #666; font-size: 0.9em;">Margin: ${todayMargin}%</div>
                        <div style="color: #666; font-size: 0.9em;">Sales: ${todayStats.count}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                        <h5 style="margin-bottom: 10px;">Last 7 Days</h5>
                        <div style="font-size: 1.2em; font-weight: bold; color: #e91e63;">${formatCurrency(weekStats.revenue)}</div>
                        <div style="color: #28a745;">Profit: ${formatCurrency(weekStats.profit)}</div>
                        <div style="color: #666; font-size: 0.9em;">Margin: ${weekMargin}%</div>
                        <div style="color: #666; font-size: 0.9em;">Sales: ${weekStats.count}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                        <h5 style="margin-bottom: 10px;">Last 30 Days</h5>
                        <div style="font-size: 1.2em; font-weight: bold; color: #e91e63;">${formatCurrency(monthStats.revenue)}</div>
                        <div style="color: #28a745;">Profit: ${formatCurrency(monthStats.profit)}</div>
                        <div style="color: #666; font-size: 0.9em;">Margin: ${monthMargin}%</div>
                        <div style="color: #666; font-size: 0.9em;">Sales: ${monthStats.count}</div>
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px;">Top Selling Products</h4>
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #e9ecef;">
                    ${topProducts.length > 0 ? topProducts.map(([name, stats]) => `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
                            <div>
                                <strong>${name}</strong>
                                <div style="font-size: 0.9em; color: #666;">Qty: ${stats.quantity}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #e91e63;">${formatCurrency(stats.revenue)}</div>
                                <div style="color: #28a745; font-size: 0.9em;">Profit: ${formatCurrency(stats.profit)}</div>
                            </div>
                        </div>
                    `).join('') : '<p style="text-align: center; color: #666;">No sales data available</p>'}
                </div>
            `;
            
            // Add profit report after stats grid
            const reportDiv = document.createElement('div');
            reportDiv.innerHTML = profitReport;
            reportDiv.style.marginTop = '30px';
            
            const existingReport = document.querySelector('#profitReport');
            if (existingReport) {
                existingReport.remove();
            }
            
            const newReport = document.createElement('div');
            newReport.id = 'profitReport';
            newReport.innerHTML = profitReport;
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.parentNode.insertBefore(newReport, statsGrid.nextSibling);
        }

        // Export to Excel function
        function exportToExcel() {
            // Prepare data for export
            const exportData = {
                products: products.map(p => ({
                    ...p,
                    variants: p.variants.map(v => ({
                        ...v,
                        profit: v.regularPrice - v.costPrice,
                        profitMargin: ((v.regularPrice - v.costPrice) / v.regularPrice * 100).toFixed(1) + '%'
                    }))
                })),
                suppliers: suppliers,
                purchaseOrders: purchaseOrders,
                stockMovements: stockMovements.slice(0, 100), // Last 100 movements
                summary: {
                    totalProducts: products.length,
                    totalVariants: products.reduce((sum, p) => sum + p.variants.length, 0),
                    totalStockValue: products.reduce((sum, p) => {
                        return sum + p.variants.reduce((vSum, v) => vSum + (v.stock * v.costPrice), 0);
                    }, 0),
                    totalSales: stockMovements.filter(m => m.type === 'sale').reduce((sum, m) => sum + (m.revenue || 0), 0),
                    totalProfit: stockMovements.filter(m => m.type === 'sale').reduce((sum, m) => sum + (m.profit || 0), 0)
                }
            };
            
            // Convert to CSV format (simplified)
            let csv = 'Family Cake POS Report\n';
            csv += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            csv += 'SUMMARY\n';
            csv += `Total Products,${exportData.summary.totalProducts}\n`;
            csv += `Total Variants,${exportData.summary.totalVariants}\n`;
            csv += `Stock Value,${exportData.summary.totalStockValue}\n`;
            csv += `Total Sales,${exportData.summary.totalSales}\n`;
            csv += `Total Profit,${exportData.summary.totalProfit}\n\n`;
            
            csv += 'PRODUCTS\n';
            csv += 'Product,Variant,Cost,Regular Price,Wholesale Price,Stock,Profit,Margin\n';
            products.forEach(p => {
                p.variants.forEach(v => {
                    const profit = v.regularPrice - v.costPrice;
                    const margin = ((profit / v.regularPrice) * 100).toFixed(1);
                    csv += `${p.name},${v.name},${v.costPrice},${v.regularPrice},${v.wholesalePrice},${v.stock},${profit},${margin}%\n`;
                });
            });
            FamilyC
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `family-cake-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('Report exported successfully!');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize the system when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadProducts();
            loadStockMovements();
            initializeCustomers();
            initializeFinance();
            updateProductGrid();
        });

        // Login button event listener
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn) {
            loginBtn.addEventListener('click', login);
        }

        // Allow Enter key to submit login
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>